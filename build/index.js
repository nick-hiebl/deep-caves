"use strict";(()=>{function lt(s,t,e){return(1-e)*s+e*t}function mt(s,t){return Math.floor((t-s)*Math.random())}function X(s,t){return s+Math.random()*(t-s)}function E(s,t){return!(s.x>=t.x+t.width||t.x>=s.x+s.width||s.y>=t.y+t.height||t.y>=s.y+s.height)}function k(s,t,e){return s.x<=t&&t<s.x+s.width&&s.y<=e&&e<s.y+s.height}function $(s){return s*s}function L(s,t,e){return s>t?Math.min(s,t+e):s<t?Math.max(s,t-e):s}function dt(s,t){return{x:s.x+t,y:s.y+t,width:s.width-2*t,height:s.height-2*t}}function F(s){return{x:s.x+s.width/2,y:s.y+s.height/2}}function pt(s,t){return Math.sqrt($(s.x-t.x)+$(s.y-t.y))}function I(s){let t=s.left??s.right-s.width,e=s.top??s.bottom-s.height,i=s.width??s.right-s.left,o=s.height??s.bottom-s.top;if(isNaN(t)||isNaN(e)||isNaN(i)||isNaN(o))throw new Error("Invalid parameters to create solid!");return{x:t,y:e,width:i,height:o}}function A({x:s,y:t,width:e,height:i}){return[s,t,e,i]}var y=class{x;y;height;width;isCollidable;isDroppable;color;xRemainder;yRemainder;blocker;constructor(t,e,i,o,r={}){this.x=t,this.y=e,this.width=i,this.height=o,this.isCollidable=!0,this.isDroppable=r.isDroppable??!1,this.blocker=!1,this.xRemainder=0,this.yRemainder=0}move(t,e,i,o){this.xRemainder+=t,this.yRemainder+=e;let r=Math.round(this.xRemainder),n=Math.round(this.yRemainder);if(r!==0||n!==0){let h=i.filter(a=>a.isRiding(this));if(this.isCollidable=!1,r!==0){if(this.xRemainder-=r,this.x+=r,r>0)for(let a of i)E(this,a)?a.moveX(this.x+this.width-a.x,a.squish,o):h.some(l=>l===a)&&a.moveX(r,()=>{},o);else if(r<0)for(let a of i)E(this,a)?a.moveX(this.x-(a.x+a.width),a.squish,o):h.some(l=>l===a)&&a.moveX(r,()=>{},o)}this.isCollidable=!0}}};var u=class{x;y;width;height;xRemainder;yRemainder;isDropping;droppingSet;grounded;isNonPhysical;constructor(t,e,i,o){this.x=Math.round(t),this.y=Math.round(e),this.width=i,this.height=o,this.xRemainder=t-this.x,this.yRemainder=e-this.y,this.isDropping=!1,this.droppingSet=new Set,this.grounded=!1,this.isNonPhysical=!1}setDropping(t){this.isDropping=!!t,this.droppingSet=new Set(Array.from(this.droppingSet).filter(e=>E(this,e)))}moveX(t,e,i){this.xRemainder+=t;let o=Math.round(this.xRemainder);if(o!==0){this.xRemainder-=o;let r=o>0?1:-1;for(;o!==0;){this.x+=r,o-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(i);if(h.forEach(a=>{this.droppingSet.add(a)}),n){this.x-=r,e(n);break}}}}moveY(t,e,i){this.yRemainder+=t;let o=Math.round(this.yRemainder);if(o!==0){this.yRemainder-=o;let r=o>0?1:-1;for(;o!==0;){this.y+=r,o-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(i);if((r<0||this.isDropping)&&h.length>0?h.forEach(a=>this.droppingSet.add(a)):h.length>0&&(n=h[0]),n){this.y-=r,e(n);break}}}}isGrounded(t){let e={x:this.x,y:this.y+this.height,width:this.width,height:1},i=t.find(o=>this.droppingSet.has(o)||this.isDropping&&o.isDroppable?!1:E(e,o));return this.grounded=!!i,this.grounded}collideAt(t){let e=[];return{collidingSolid:t.find(o=>!o.isCollidable||!E(this,o)?!1:o.isDroppable?(this.droppingSet.has(o)||e.push(o),!1):!0),droppingThroughSolids:e}}isRiding(t){return E(t,{x:this.x,y:this.y+this.height,width:this.width,height:1})}squish(){console.log("Squish")}};var bt=s=>{let t=s;return(e,{onLock:i,onRelease:o})=>{e!==t&&(t=e,e?i&&i():o&&o())}},J=(s,t)=>{let e=0;return{up(i=1){e=Math.min(1,e+i/s)},down(i=1){e=Math.max(0,e-i/t)},check(){return e}}};var D=s=>{let t=new Image;return t.src=s,t};function P(s){return s!=null}var Ot=.0021000000000000003,Lt=4.5/1e3,Pt=-.2,q=100,Ht=" ",Z=class{isGrounded;coyoteTime;timeSinceJumpPress;isJumpKeyDown;stillHoldingJump;constructor(){this.isGrounded=!1,this.coyoteTime=0,this.timeSinceJumpPress=q*2,this.isJumpKeyDown=!1,this.stillHoldingJump=!1}update(t,e,i){this.coyoteTime-=e,t[Ht]?this.isJumpKeyDown?this.timeSinceJumpPress+=e:(this.isJumpKeyDown=!0,this.timeSinceJumpPress=0):(this.stillHoldingJump=!1,this.isJumpKeyDown=!1,this.timeSinceJumpPress=q*2);let r=this.isJumpKeyDown&&this.timeSinceJumpPress<q&&(this.isGrounded||this.coyoteTime>0);return r&&(this.stillHoldingJump=!0,this.timeSinceJumpPress=q*2,this.coyoteTime=0),{isJumping:r,yAcceleration:this.getGravity(i)}}getGravity(t){return t>Pt||!this.stillHoldingJump?Lt:Ot}groundedCheck(t,e){this.isGrounded&&!t&&!e?this.coyoteTime=q:t&&(this.coyoteTime=0),this.isGrounded=t}};var ut=class{map=new Map;add(t){this.map.set(t.constructor,t)}get(t){return this.map.get(t)}has(t){return this.map.has(t)}delete(t){this.map.delete(t)}},Q=class{entities=new Map;systems=new Map;nextEntityId=0;entitiesToDelete=new Array;addEntity(){let t=this.nextEntityId;return this.nextEntityId++,this.entities.set(t,new ut),t}removeEntity(t){this.entitiesToDelete.push(t)}addComponent(t,e){let i=this.entities.get(t);i&&(i.add(e),this.checkEntitySystemMemberships(t))}getComponents(t){let e=this.entities.get(t);if(!e)throw new Error("Could not find requested entity");return e}removeComponent(t,e){let i=this.entities.get(t);i&&(i.delete(e),this.checkEntitySystemMemberships(t))}addSystem(t){t.ecs=this,this.systems.set(t,new Set);for(let e of this.entities.keys())this.checkEntitySystemMembership(e,t)}querySystem(t){return Array.from(this.systems.entries()).find(([e])=>e instanceof t)?.[1]}resolveEntities(t,e){return t?Array.from(t.values()).map(i=>this.getComponents(i)).map(i=>i.get(e)):[]}removeSystem(t){this.systems.delete(t)}update(t){this.systems.entries().forEach(([e,i])=>{e.update(i,t)}),this.entitiesToDelete.forEach(e=>{this.deleteEntity(e)}),this.entitiesToDelete=[]}draw(t){this.systems.entries().forEach(([e,i])=>{e.draw?.(i,t)})}deleteEntity(t){this.entities.delete(t),this.systems.values().forEach(e=>{e.delete(t)})}checkEntitySystemMemberships(t){for(let e of this.systems.keys())this.checkEntitySystemMembership(t,e)}checkEntitySystemMembership(t,e){let i=this.entities.get(t),o=this.systems.get(e);!i||!o||(Array.from(e.componentSet).every(r=>i.has(r))?o.add(t):o.delete(t))}};var M=class{color;rect;opacity;constructor(t,e){this.color=e,this.rect=t,this.opacity=1}},tt=class{componentSet=new Set([M]);ecs;color;constructor(t){this.color=t}update(){}draw(t,e){t.values().map(o=>this.ecs.getComponents(o)).filter(P).map(o=>o.get(M)).forEach(({rect:o,color:r,opacity:n})=>{n<=0||(n<1&&(e.filter=`opacity(${Math.round(100*n)}%)`),r?e.fillStyle=r:e.fillStyle=this.color,e.fillRect(o.x,o.y,o.width,o.height),e.filter="none")})}};var et=300/1e3,wt=1/1e3,Ft=2/1e3,Nt=D("./img/ghosty.png"),Rt=24,Bt=32;var ft=class{},z=class{hp;facing;isNonPhysical;hurtViz;constructor(){this.hp=3,this.facing="left",this.isNonPhysical=!0,this.hurtViz=J(1,250)}},K=class{componentSet=new Set([ft]);ecs;update(){}},it=class{componentSet=new Set([z,u,x]);ecs;update(t,{frameDuration:e}){let i=this.ecs.resolveEntities(this.ecs.querySystem(T),u).map(r=>F(r));Array.from(t.values().map(r=>this.ecs.getComponents(r))).forEach(r=>{let n=r.get(z),h=F(r.get(u)),a=r.get(x).velocity,[l]=i.reduce(([m,f],w)=>{let R=pt(h,w);return R<f?[w,R]:[m,f]},[void 0,1/0]);l&&(l.x<h.x?(a.x=L(-et,a.x,wt*e),n.facing="left"):(a.x=L(et,a.x,wt*e),n.facing="right"),a.y=L(l.y<h.y?-et:et,a.y,Ft*e))})}draw(t,e){t.values().forEach(i=>{let o=this.ecs.getComponents(i),r=o.get(z),n=o.get(u);e.drawImage(Nt,r.facing==="left"?0:Rt,0,Rt,Bt,n.x,n.y,n.width,n.height)})}};var x=class{velocity;constructor(t){this.velocity=t}},H=class{componentSet=new Set([y]);ecs;state="pre-lock";update(t){if(this.state==="pre-lock"){let e=this.ecs.resolveEntities(this.ecs.querySystem(T),u),i=this.ecs.resolveEntities(t,y).filter(o=>o.blocker);if(i.some(o=>e.some(r=>E(o,r))))return;i.forEach(o=>{o.isCollidable=!0}),this.state="locked"}else if(this.state==="locked"){let e=this.ecs.querySystem(K);if(e&&e.size>0)return;t.values().filter(i=>this.ecs.getComponents(i).get(y).blocker).forEach(i=>{this.ecs.removeEntity(i)})}}},Y=class{componentSet=new Set([u]);ecs;update(t,{frameDuration:e}){let i=Array.from(t).map(r=>this.ecs.getComponents(r)),o=this.ecs.resolveEntities(this.ecs.querySystem(H),y);i.forEach(r=>{let n=r.get(u),h=n.isNonPhysical?[]:o;if(r.has(x)){let a=r.get(x).velocity;n.moveX(a.x*e,()=>{},h),n.moveY(a.y*e,()=>{a.y=0},h)}n.isGrounded(o)})}};var j=class{lifespan;age;constructor(t){this.lifespan=t,this.age=0}},ot=class{componentSet=new Set([M,j,x]);ecs;update(t,{frameDuration:e}){t.values().forEach(i=>{let o=this.ecs.getComponents(i),r=o.get(j),n=o.get(M),{velocity:h}=o.get(x);r.age+=e,r.age>=r.lifespan?this.ecs.removeEntity(i):(n.rect.x+=h.x*e,n.rect.y+=h.y*e,n.opacity=1-$(r.age/r.lifespan))})}};function St(s,t,e,i,o,r){let n=s.addEntity();return s.addComponent(n,new M({x:t.x-e,y:t.y-e,width:e*2,height:e*2},o)),s.addComponent(n,new x(i)),s.addComponent(n,new j(r)),n}var Gt="a",kt="s",Kt="d";var yt=28,Et=36,Yt=28,Ut=36,Wt=250/1e3,Xt=1.3/1e3,Jt=.7,qt=D("./img/sword_man.png"),zt=(s,t,e)=>{let i=0,o=0;return t==="right"&&(i+=yt),s&&(o+=Et),e&&(i+=yt*2),{x:i,y:o}},O=class{facing;jumpController;constructor(){this.facing="left",this.jumpController=new Z}},T=class{componentSet=new Set([O,u,x]);ecs;update(t,{frameDuration:e,keyboardState:i}){t.values().map(o=>this.ecs.getComponents(o)).filter(P).forEach(o=>{let r=o.get(u),n=o.get(x).velocity,h=o.get(O),a=(i[Kt]?1:0)-(i[Gt]?1:0);n.x=L(a*Wt,n.x,Xt*e);let{yAcceleration:l,isJumping:m}=h.jumpController.update(i,e,n.y);if(n.y+=l*e,m){let f={x:r.x+r.width/2,y:r.y+r.height},w=2;for(let R=0;R<10;R++){let G=X(-.3,.3);St(this.ecs,{x:f.x+G*r.width,y:f.y},w,{x:G*.6,y:X(.05,.11)*(Math.random()<.7?1:-1)},"white",X(140,240))}n.y=-Jt}a>0?h.facing="right":a<0&&(h.facing="left"),r.setDropping(i[kt]),h.jumpController.groundedCheck(r.grounded,m)})}draw(t,e){t.values().map(i=>this.ecs.getComponents(i)).filter(P).forEach(i=>{let o=i.get(u),r=i.get(O),n=!1,{x:h,y:a}=zt(n,r.facing,!0);e.drawImage(qt,h,a,yt,Et,o.x,o.y,o.width,o.height)})}},Ct=(s,t,e)=>{let i=s.addEntity();return s.addComponent(i,new O),s.addComponent(i,new u(t,e,Yt,Ut)),s.addComponent(i,new x({x:0,y:0})),i};var U=class{loopDuration;start;midpoint;loopState;constructor(t,e,i){this.loopDuration=t,this.start=e,this.midpoint=i,this.loopState=0}},st=class{componentSet=new Set([y,U]);ecs;update(t,{frameDuration:e}){let i=this.ecs.resolveEntities(this.ecs.querySystem(Y),u).filter(r=>!r.isNonPhysical),o=this.ecs.resolveEntities(this.ecs.querySystem(H),y);t.values().forEach(r=>{let n=this.ecs.getComponents(r),h=n.get(U),a=n.get(y);h.loopState+=e,h.loopState%=h.loopDuration;let l=h.loopState<h.loopDuration/2?h.loopState/h.loopDuration*2:2-h.loopState/h.loopDuration*2,m={x:lt(h.start.x,h.midpoint.x,l),y:lt(h.start.y,h.midpoint.y,l)};a.move(m.x-(a.x+a.xRemainder),m.y-(a.y+a.yRemainder),i,o)})}};var V=(s,t)=>{let e=s.x??s.left,i=s.y??s.top,o=s.width??s.right-e,r=s.height??s.bottom-i;if(isNaN(e)||isNaN(i)||isNaN(o)||isNaN(r))throw new Error("Invalid parameters to create solid!");return new y(e,i,o,r,t)},C=(s={})=>{let t=Object.keys(s).filter(e=>s[e]);return t.sort((e,i)=>g[e][0]-g[i][0]),t};var N=s=>{let t=b*3,e=[],i=[],o=d/2-t/2,r=o+t,n=[0].concat(C(s.top).map(c=>g[c][1])),h=C(s.top).map(c=>g[c][0]).concat(d);e.push(...n.map((c,S)=>V({left:c,right:h[S],y:0,height:b}))),i.push(...C(s.top).map(c=>g[c]).map(([c,S])=>V({left:c,right:S,y:0,height:b})));let a=[0].concat(C(s.bottom).map(c=>g[c][1])),l=C(s.bottom).map(c=>g[c][0]).concat(d);e.push(...a.map((c,S)=>V({left:c,right:l[S],y:p-b,height:b}))),e.push(...C(s.bottom).map(c=>V({left:g[c][0],right:g[c][1],top:p-b,height:b/4},{isDroppable:!0}))),i.push(...C(s.bottom).map(c=>g[c]).map(([c,S])=>V({left:c,right:S,y:p-b,height:b})));let m=[0].concat(C(s.left).map(c=>g[c][1])),f=C(s.left).map(c=>g[c][0]).concat(p);e.push(...m.map((c,S)=>V({top:c,bottom:f[S],left:0,width:b}))),i.push(...C(s.left).map(c=>g[c]).map(([c,S])=>V({top:c,bottom:S,x:0,width:b})));let w=[0].concat(C(s.right).map(c=>g[c][1])),R=C(s.right).map(c=>g[c][0]).concat(p);e.push(...w.map((c,S)=>V({top:c,bottom:R[S],left:d-b,width:b}))),i.push(...C(s.right).map(c=>g[c]).map(([c,S])=>V({top:c,bottom:S,x:d-b,width:b})));let G=[];return G.push(V({left:o-t,width:t,top:200,height:b/4},{isDroppable:!0})),G.push(V({left:o,right:r,top:100,height:b/4},{isDroppable:!0})),{blockers:i.map(c=>(c.blocker=!0,c.color="brown",c.isCollidable=!1,c)),solids:e,ladders:G}};var b=15,d=480,p=270,g={high:[40,80],medium:[p/2-20,p/2+20],low:[p-80,p-40],left:[80,180],center:[d/2-50,d/2+50],right:[d-180,d-80]},Dt=["left","center","right"],Mt=["high","medium","low"],_=class{getDoorwayChance(){return .5}static getDoorArrangement(){return{top:{},bottom:{},left:{},right:{}}}static isValidAt(t,e){return!0}static areDoorsOk(t){let e=this.getDoorArrangement();return Mt.every(i=>(e.left[i]===void 0||t.left[i]===void 0||e.left[i]===t.left[i])&&(e.right[i]===void 0||t.right[i]===void 0||e.right[i]===t.right[i]))&&Dt.every(i=>(e.top[i]===void 0||t.top[i]===void 0||e.top[i]===t.top[i])&&(e.bottom[i]===void 0||t.bottom[i]===void 0||e.bottom[i]===t.bottom[i]))}x;y;width;height;color;blockersLocked;allEnemiesCleared;doors;ecs;roomCollider;exits;constructor(t,e,i,o,r="blue",n={},h){this.x=t,this.y=e,this.width=i,this.height=o,this.roomCollider={x:0,y:0,width:i*d,height:o*p},this.exits=[],this.setupExits(),this.ecs=new Q,this.ecs.addSystem(new Y),this.ecs.addSystem(new H),this.ecs.addSystem(new tt(r)),this.ecs.addSystem(new T),this.ecs.addSystem(new st),this.ecs.addSystem(new K),this.ecs.addSystem(new it),this.ecs.addSystem(new ot),this.color=r,this.blockersLocked=!1,this.allEnemiesCleared=!1,this.doors={left:n.left??{},right:n.right??{},top:n.top??{},bottom:n.bottom??{}},this.globalDoorwayRectification(),this.configureAllDoors(),this.configureRoomContent(h);let a=h?.playerStart??{x:.5*d,y:.08*p};Ct(this.ecs,a.x,a.y)}setupExits(){for(let e=0;e<this.width;e++)this.exits.push({collider:{x:e*d,y:-100,width:d,height:100},roomPos:{x:this.x+e,y:this.y-1},direction:"top"});for(let e=0;e<this.width;e++)this.exits.push({collider:{x:e*d,y:this.height*p,width:d,height:100},roomPos:{x:this.x+e,y:this.y+this.height},direction:"bottom"});for(let e=0;e<this.height;e++)this.exits.push({collider:{x:-100,y:e*p,width:100,height:p},roomPos:{x:this.x-1,y:this.y+e},direction:"left"});for(let e=0;e<this.height;e++)this.exits.push({collider:{x:this.width*d,y:e*p,width:100,height:p},roomPos:{x:this.x+this.width,y:this.y+e},direction:"right"})}globalDoorwayRectification(){this.x===0&&this.y===0?this.doors={bottom:{center:!0,left:!1,right:!1},top:{center:!1,left:!1,right:!1},left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1}}:this.x===0&&this.y===1?this.doors.top={center:!0,left:!1,right:!1}:this.y===1&&(this.doors.top={center:!1,left:!1,right:!1})}configureAllDoors(){let t=this.constructor.getDoorArrangement(),e=this.getDoorwayChance();Mt.forEach(i=>{this.doors.left[i]===void 0&&(this.doors.left[i]=t.left[i]??Math.random()<e),this.doors.right[i]===void 0&&(this.doors.right[i]=t.right[i]??Math.random()<e)}),Dt.forEach(i=>{this.doors.top[i]===void 0&&(this.doors.top[i]=t.top[i]??Math.random()<e),this.doors.bottom[i]===void 0&&(this.doors.bottom[i]=t.bottom[i]??Math.random()<e)})}configureRoomContent(t){if(t){t.blocks.forEach(h=>{let a=this.ecs.addEntity(),l=new y(...A(h));this.ecs.addComponent(a,l),this.ecs.addComponent(a,new M(l))});return}let{solids:e,blockers:i,ladders:o}=N(this.doors);e.concat(i).concat(o).forEach(h=>{let a=this.ecs.addEntity();this.ecs.addComponent(a,h),this.ecs.addComponent(a,new M(h,h.color))});let r=this.ecs.addEntity(),n=new y(220,140,100,15);this.ecs.addComponent(r,n),this.ecs.addComponent(r,new M(n,this.color)),this.ecs.addComponent(r,new U(7e3,{x:220,y:140},{x:300,y:140}))}draw(t,e,i,o){t.fillStyle="black",t.fillRect(0,0,e.width,e.height),this.ecs.draw(t)}update(t,e,i,o){this.ecs.update({mousePosition:t,keyboardState:e,frameDuration:i}),this.validateLeavingRoom(o)}validateLeavingRoom(t){let i=Array.from(this.ecs.querySystem(T)?.values()??[]).map(m=>this.ecs.getComponents(m))[0];if(!i)throw new Error("No player found.");let o=i.get(u),r=F(o);if(k(this.roomCollider,r.x,r.y))return;let n=this.exits.find(m=>k(m.collider,r.x,r.y));if(!n)throw new Error("Player outside of room collider but has not hit any exit!");let{direction:h,roomPos:a}=n,l=h==="top"||h==="bottom"?{[h==="top"?"bottom":"top"]:{[["left","center","right"].find(m=>r.x>=g[m][0]&&r.x<g[m][1])]:!0}}:{[h==="left"?"right":"left"]:{[["low","medium","high"].find(m=>r.y>=g[m][0]&&r.y<g[m][1])]:!0}};t(a.x,a.y,l)}setExternalMatchingDoorways(t){let e={};for(let i in t){let o=i;for(let r in t[o]){let n=r;if(o==="left"||o==="right"){let h=r;t[o][h]===!1&&this.doors[o][h]===!0&&(e[o]=e[o]??{},e[o][h]=!0)}else{let h=r;t[o][h]===!1&&this.doors[o][h]===!0&&(e[o]=e[o]??{},e[o][h]=!0)}}}}drawForMap(t){t.fillStyle=this.color;let e=this.ecs.resolveEntities(this.ecs.querySystem(H),y);for(let i of e)i.blocker||t.fillRect(i.x,i.y,i.width,i.height)}};var Ci=500/1e3,Di=D("./img/theghost.png"),Mi={x:100,y:100,width:d-200,height:p-200},Ti={x:-100,y:-100,width:d+200,height:p+200};var ji=2.5/1e3,$i=D("./img/spitboss-head.png"),Zi=D("./img/spitboss-base.png"),Qi=D("./img/spitboss-spit.png");var po=300/1e3,uo=1/1e3,fo=2/1e3,yo=D("./img/ghosty.png");var Ro=180/1e3,So=2/1e3,Eo=2.5/1e3;var gt=class{roomLayouts;constructor(){this.roomLayouts=[]}setFromGameFile(t){this.roomLayouts=t.levels.map(e=>new xt(e))}getValidWithDoors(t){return this.roomLayouts.slice()}},xt=class{name;width;height;blocks;playerStart;constructor(t){this.name=t.identifier,this.width=Math.round(t.pxWid/d),this.height=Math.round(t.pxHei/p);let e=t.layerInstances.find(i=>i.__type==="Entities");if(!e)throw new Error(`Level: ${t.identifier} has no entities`);this.blocks=e.entityInstances.filter(i=>i.__identifier==="Solid").map(i=>({x:i.px[0],y:i.px[1],width:i.width,height:i.height})),this.playerStart=e.entityInstances.filter(i=>i.__identifier==="PlayerStart").map(i=>({x:i.px[0],y:i.px[1]})).find(P)??{x:0,y:0}}drawForMap(t){t.fillStyle="green";let e=this.blocks;for(let i of e)t.fillRect(i.x,i.y,i.width,i.height)}},rt=new gt,vt=fetch("./game.ldtk").then(s=>s.json()).then(s=>{rt.setFromGameFile(s)});var B=128,W=72,At=9,Vt=6,_t=128/480,It=4,nt=class{lastRoomIndex;map;x;y;currentIndex;minX;minY;canvas;ctx;constructor(){this.lastRoomIndex={x:0,y:0},this.map={},this.x=0,this.y=0,this.currentIndex=this.index(0,0),this.minX=0,this.minY=0;let t=rt.roomLayouts.find(n=>n.name==="Start_Room"),e=new _(0,0,1,1,void 0,void 0,t);this.map[this.index(0,0)]=e;let i=Math.max(At),o=Math.max(Vt);this.canvas=new OffscreenCanvas(i*B,o*W);let r=this.canvas.getContext("2d");if(!r)throw Error("Could not construct canvas");this.ctx=r,this.redrawWorldMap()}createNewCanvas(t,e,i,o){let r=Math.max(At,e-t+1+It),n=Math.max(Vt,o-i+1+It);this.canvas=new OffscreenCanvas(r*B,n*W);let h=this.canvas.getContext("2d");if(!h)throw Error("Could not construct canvas");this.ctx=h}getNeighboringDoors(t,e){return{right:{...this.map[this.index(t+1,e)]?.doors?.left},left:{...this.map[this.index(t-1,e)]?.doors?.right},top:{...this.map[this.index(t,e-1)]?.doors?.bottom},bottom:{...this.map[this.index(t,e+1)]?.doors?.top}}}generateRoomChoices(t,e,i={}){let o=()=>`hsl(${mt(0,360)}, 60%, 60%)`,n={left:{...i.left??{}},right:{...i.right??{}},top:{...i.top??{}},bottom:{...i.bottom??{}}},h=rt.getValidWithDoors(n),a=[];for(let l=0;l<3;l++){let m=h.shift();if(!m)throw new Error("Could not find enough rooms");a.push(m)}return a}redrawWorldMap(){let t=0,e=0;for(let i of Object.values(this.map))this.minX=Math.min(this.minX,i.x),t=Math.max(t,i.x),this.minY=Math.min(this.minY,i.y),e=Math.max(e,i.y);(t-this.minX+1>this.canvas.width/B||e-this.minY+1>this.canvas.height/W)&&this.createNewCanvas(this.minX,t,this.minY,e),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let i of Object.values(this.map))this.ctx.save(),this.ctx.translate((i.x-this.minX)*B,(i.y-this.minY)*W),this.ctx.scale(_t,_t),i.drawForMap(this.ctx),this.ctx.restore()}drawMapToScreen(t,e,i,o,r){let a=Math.min(o,this.canvas.width),l=Math.min(r,this.canvas.height),m=(-this.minX+this.x+1/2)*B-o/2;t.drawImage(this.canvas,m,0,a,l,e,i,a,l),t.fillStyle="white";let f=dt({x:-m+(this.x-this.minX+1/2)*B,y:i+this.y*W,width:B,height:W},-2),w=f.x+f.width,R=f.y+f.height;t.fillRect(...A(I({left:f.x,width:10,top:f.y,height:2}))),t.fillRect(...A(I({left:f.x,width:2,top:f.y,height:10}))),t.fillRect(...A(I({right:w,width:10,top:f.y,height:2}))),t.fillRect(...A(I({right:w,width:2,top:f.y,height:10}))),t.fillRect(...A(I({left:f.x,width:10,bottom:R,height:2}))),t.fillRect(...A(I({left:f.x,width:2,bottom:R,height:10}))),t.fillRect(...A(I({right:w,width:10,bottom:R,height:2}))),t.fillRect(...A(I({right:w,width:2,bottom:R,height:10})))}index(t,e){return`${t},${e}`}getCurrentRoom(){return this.map[this.currentIndex]}getPreviousRoom(){return this.map[this.index(this.lastRoomIndex.x,this.lastRoomIndex.y)]}hasRoom(t,e){return this.index(t,e)in this.map}enterRoom(t,e){this.lastRoomIndex={x:this.x,y:this.y},this.x=t,this.y=e,this.currentIndex=this.index(t,e),this.redrawWorldMap()}addRoom(t){if(this.map[this.currentIndex])throw new Error("Adding room where we already have one!");this.map[this.currentIndex]=t,this.map[this.index(this.x-1,this.y)]?.setExternalMatchingDoorways?.({right:t.doors.left}),this.map[this.index(this.x+1,this.y)]?.setExternalMatchingDoorways?.({left:t.doors.right}),this.map[this.index(this.x,this.y-1)]?.setExternalMatchingDoorways?.({bottom:t.doors.top}),this.map[this.index(this.x,this.y+1)]?.setExternalMatchingDoorways?.({top:t.doors.bottom}),t.setExternalMatchingDoorways({left:this.map[this.index(this.x-1,this.y)]?.doors?.right,right:this.map[this.index(this.x+1,this.y)]?.doors?.left,top:this.map[this.index(this.x,this.y-1)]?.doors?.bottom,bottom:this.map[this.index(this.x,this.y+1)]?.doors?.top}),this.redrawWorldMap()}};var ht=10,$t="Tab",v=64,at=4,ct=class{worldMap;lastFrameTime;unprocessedTime;pausedFor;choosing;choices;tabLatch;mouseOverChoiceIndex;firstTickInNewRoom;constructor(){this.worldMap=new nt,this.lastFrameTime=performance.now(),this.unprocessedTime=0,this.pausedFor=void 0,this.choosing=!0,this.choices=[],this.tabLatch=bt(!1),this.mouseOverChoiceIndex=-1,this.firstTickInNewRoom=!1}update(t,e,i,o){if(this.tabLatch(!!o[$t],{onLock:()=>{this.pausedFor==="Tab"?(this.lastFrameTime=performance.now(),this.pausedFor=void 0):this.pausedFor||(this.pausedFor="Tab")}}),this.pausedFor==="choices"){this.choices.length===0&&(this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y)),this.draw(t,e,i,0),this.drawMap(t,e),this.drawOptions(t,e,i);return}else if(this.pausedFor==="Tab"){this.draw(t,e,i,0),this.drawMap(t,e);return}let r=performance.now(),n=this.firstTickInNewRoom?0:Math.min(r-this.lastFrameTime,250);for(this.lastFrameTime=r,this.firstTickInNewRoom=!1,this.unprocessedTime+=n;this.unprocessedTime>=ht&&!this.pausedFor;)this.simulateFrame(i,o),this.unprocessedTime-=ht;this.pausedFor&&(this.unprocessedTime=0);let h=this.unprocessedTime/ht;this.draw(t,e,i,h)}drawMap(t,e){t.fillStyle="#00000099",t.fillRect(0,0,e.width,e.height),t.fillStyle="white",t.fillRect(v-at,v-at,e.height-(v-at)*2,e.height-(v-at)*2),t.fillStyle="black",t.fillRect(v,v,e.height-v*2,e.height-v*2),this.worldMap.drawMapToScreen(t,v,v,e.height-v*2,e.height-v*2)}click(t,e){let i=this.pausedFor==="choices"&&this.choices.length>0,o=this.mouseOverChoiceIndex>=0&&this.mouseOverChoiceIndex<this.choices.length;if(i&&o){let r=this.choices[this.mouseOverChoiceIndex],n=new _(this.worldMap.x,this.worldMap.y,r.width,r.height,void 0,void 0,r);this.worldMap.addRoom(n);let h=this.worldMap.getPreviousRoom();this.transferPlayerPosition(h,n),this.unprocessedTime=0,this.firstTickInNewRoom=!0,this.pausedFor=void 0,this.choices=[]}}transferPlayerPosition(t,e){let i=t.ecs.querySystem(T),o=e.ecs.querySystem(T);if(i?.size!==1||o?.size!==1)return;let r=t.ecs.getComponents(Array.from(i.values())[0]),n=e.ecs.getComponents(Array.from(o.values())[0]);if(!r||!n)return;let h=r.get(u),a=n.get(u),l=r.get(x).velocity,m=n.get(x).velocity;m.x=l.x,m.y=Math.min(l.y,.1);let f=h.x+t.x*d,w=h.y+t.y*p;a.x=f-e.x*d,a.y=w-e.y*p,e.y>=t.y+t.height?m.y=Math.min(m.y,1):e.y+e.height<=t.y&&(m.y=Math.min(-.6,m.y)),n.get(O).facing=r.get(O).facing}simulateFrame(t,e){this.worldMap.getCurrentRoom().update(t,e,ht,this.onRoomChange.bind(this))}onRoomChange(t,e,i){this.worldMap.hasRoom(t,e)?(this.worldMap.enterRoom(t,e),this.transferPlayerPosition(this.worldMap.getPreviousRoom(),this.worldMap.getCurrentRoom())):(this.pausedFor="choices",this.worldMap.enterRoom(t,e),this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y,i))}draw(t,e,i,o){let r=this.worldMap.getCurrentRoom();r&&(t.save(),t.scale(2,2),r.draw(t,e,i,o),t.restore())}drawOptions(t,e,i){this.mouseOverChoiceIndex=-1;for(let o=0;o<this.choices.length;o++){let r=this.choices[o],n=e.height,h=e.width,a=(n+h)/2,l=e.height/this.choices.length,m=l*o,f=m+l;t.save(),t.translate(a,(m+f)/2);let w=i&&k({x:n,y:m,width:h-n,height:l},i.x,i.y),R=(h-n)/d*.5;t.scale(R,R),w&&(this.mouseOverChoiceIndex=o,t.scale(1.1,1.1)),t.translate(-d/2,-p/2),r.drawForMap(t),t.restore()}}};function Zt(){let s=document.getElementById("canvas");if(!s){console.error("Could not find canvas");return}let t=s.getContext("2d");if(!t)throw Error("Could not set up canvas rendering context");t.imageSmoothingEnabled=!1;let e=new ct,i;s.addEventListener("mousemove",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,l=n.clientY-h.top;i={x:a,y:l}}),s.addEventListener("mouseleave",()=>{i=void 0}),s.addEventListener("click",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,l=n.clientY-h.top;i={x:a,y:l},e.click(s,i)});let o={};window.addEventListener("keydown",n=>{o[n.key]=!0,(n.key==="Tab"||n.key===" ")&&n.preventDefault()}),window.addEventListener("keyup",n=>{delete o[n.key]}),window.addEventListener("blur",()=>{o={}});function r(){e.update(t,s,i,o),requestAnimationFrame(r)}r()}document.addEventListener("DOMContentLoaded",()=>{vt.then(()=>{Zt()})});})();
//# sourceMappingURL=index.js.map
