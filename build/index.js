"use strict";(()=>{function Mt(s,t,e){return(1-e)*s+e*t}function W(s,t){return Math.floor((t-s)*Math.random())}function b(s,t){return s+Math.random()*(t-s)}function g(s,t){return!(s.x>=t.x+t.width||t.x>=s.x+s.width||s.y>=t.y+t.height||t.y>=s.y+s.height)}function G(s,t,e){return s.x<=t&&t<s.x+s.width&&s.y<=e&&e<s.y+s.height}function st(s){return s*s}function C(s,t,e){return s>t?Math.min(s,t+e):s<t?Math.max(s,t-e):s}function Bt(s,t,e){return Math.max(t,Math.min(s,e))}function Yt(s,t){return{x:Bt(s.x,t.x,t.x+t.width),y:Bt(s.y,t.y,t.y+t.height)}}function rt(s,t){return{x:s.x+t,y:s.y+t,width:s.width-2*t,height:s.height-2*t}}function O(s){return{x:s.x+s.width/2,y:s.y+s.height/2}}function At(s,t){let e=Math.sqrt(s.x*s.x+s.y*s.y);return{x:s.x*t/e,y:s.y*t/e}}function $(s,t){return Math.sqrt(st(s.x-t.x)+st(s.y-t.y))}function Gt(s){let t=s.width+s.height,e=b(0,t);return e<s.width?{x:s.x+e,y:W(0,2)?s.y:s.y+s.height}:{x:W(0,2)?s.x:s.x+s.width,y:s.y+(e-s.width)}}function Ut(s){return{x:s.x+b(0,s.width),y:s.y+b(0,s.height)}}function F(s){let t=s.left??s.right-s.width,e=s.top??s.bottom-s.height,i=s.width??s.right-s.left,o=s.height??s.bottom-s.top;if(isNaN(t)||isNaN(e)||isNaN(i)||isNaN(o))throw new Error("Invalid parameters to create solid!");return{x:t,y:e,width:i,height:o}}function N({x:s,y:t,width:e,height:i}){return[s,t,e,i]}var c=class{x;y;height;width;isCollidable;isDroppable;color;xRemainder;yRemainder;blocker;constructor(t,e,i,o,r={}){this.x=t,this.y=e,this.width=i,this.height=o,this.isCollidable=!0,this.isDroppable=r.isDroppable??!1,this.blocker=!1,this.xRemainder=0,this.yRemainder=0}move(t,e,i,o){this.xRemainder+=t,this.yRemainder+=e;let r=Math.round(this.xRemainder),n=Math.round(this.yRemainder);if(r!==0||n!==0){let h=i.filter(a=>a.isRiding(this));if(this.isCollidable=!1,r!==0){if(this.xRemainder-=r,this.x+=r,r>0)for(let a of i)g(this,a)?a.moveX(this.x+this.width-a.x,a.squish,o):h.some(m=>m===a)&&a.moveX(r,()=>{},o);else if(r<0)for(let a of i)g(this,a)?a.moveX(this.x-(a.x+a.width),a.squish,o):h.some(m=>m===a)&&a.moveX(r,()=>{},o)}this.isCollidable=!0}}};var y=class{x;y;width;height;xRemainder;yRemainder;isDropping;droppingSet;grounded;isNonPhysical;constructor(t,e,i,o){this.x=t,this.y=e,this.width=i,this.height=o,this.xRemainder=0,this.yRemainder=0,this.isDropping=!1,this.droppingSet=new Set,this.grounded=!1,this.isNonPhysical=!1}setDropping(t){this.isDropping=!!t,this.droppingSet=new Set(Array.from(this.droppingSet).filter(e=>g(this,e)))}moveX(t,e,i){this.xRemainder+=t;let o=Math.round(this.xRemainder);if(o!==0){this.xRemainder-=o;let r=o>0?1:-1;for(;o!==0;){this.x+=r,o-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(i);if(h.forEach(a=>{this.droppingSet.add(a)}),n){this.x-=r,e(n);break}}}}moveY(t,e,i){this.yRemainder+=t;let o=Math.round(this.yRemainder);if(o!==0){this.yRemainder-=o;let r=o>0?1:-1;for(;o!==0;){this.y+=r,o-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(i);if((r<0||this.isDropping)&&h.length>0?h.forEach(a=>this.droppingSet.add(a)):h.length>0&&(n=h[0]),n){this.y-=r,e(n);break}}}}isGrounded(t){let e={x:this.x,y:this.y+this.height,width:this.width,height:1},i=t.find(o=>this.droppingSet.has(o)||this.isDropping&&o.isDroppable?!1:g(e,o));return this.grounded=!!i,this.grounded}collideAt(t){let e=[];return{collidingSolid:t.find(o=>!o.isCollidable||!g(this,o)?!1:o.isDroppable?(this.droppingSet.has(o)||e.push(o),!1):!0),droppingThroughSolids:e}}isRiding(t){return g(t,{x:this.x,y:this.y+this.height,width:this.width,height:1})}squish(){console.log("Squish")}};var kt=s=>{let t=s;return(e,{onLock:i,onRelease:o})=>{e!==t&&(t=e,e?i&&i():o&&o())}},P=(s,t)=>{let e=0;return{up(i=1){e=Math.min(1,e+i/s)},down(i=1){e=Math.max(0,e-i/t)},check(){return e}}};var v=s=>{let t=new Image;return t.src=s,t};function U(s){return s!=null}var nt=class{isGrounded;coyoteTime;timeSinceJumpPress;isJumpKeyDown;stillHoldingJump;constructor(){this.isGrounded=!1,this.coyoteTime=0,this.timeSinceJumpPress=200,this.isJumpKeyDown=!1,this.stillHoldingJump=!1}update(t,e,i){this.coyoteTime-=e,t[" "]?this.isJumpKeyDown?this.timeSinceJumpPress+=e:(this.isJumpKeyDown=!0,this.timeSinceJumpPress=0):(this.stillHoldingJump=!1,this.isJumpKeyDown=!1,this.timeSinceJumpPress=200);let r=this.isJumpKeyDown&&this.timeSinceJumpPress<100&&(this.isGrounded||this.coyoteTime>0);return r&&(this.stillHoldingJump=!0,this.timeSinceJumpPress=200,this.coyoteTime=0),{isJumping:r,yAcceleration:this.getGravity(i)}}getGravity(t){return t>-.5||!this.stillHoldingJump?.006:.0025}groundedCheck(t,e){this.isGrounded&&!t&&!e?this.coyoteTime=100:t&&(this.coyoteTime=0),this.isGrounded=t}};var vt=class{map=new Map;add(t){this.map.set(t.constructor,t)}get(t){return this.map.get(t)}has(t){return this.map.has(t)}delete(t){this.map.delete(t)}},ht=class{entities=new Map;systems=new Map;nextEntityId=0;entitiesToDelete=new Array;addEntity(){let t=this.nextEntityId;return this.nextEntityId++,this.entities.set(t,new vt),t}removeEntity(t){this.entitiesToDelete.push(t)}addComponent(t,e){let i=this.entities.get(t);i&&(i.add(e),this.checkEntitySystemMemberships(t))}getComponents(t){let e=this.entities.get(t);if(!e)throw new Error("Could not find requested entity");return e}removeComponent(t,e){let i=this.entities.get(t);i&&(i.delete(e),this.checkEntitySystemMemberships(t))}addSystem(t){t.ecs=this,this.systems.set(t,new Set);for(let e of this.entities.keys())this.checkEntitySystemMembership(e,t)}querySystem(t){return Array.from(this.systems.entries()).find(([e])=>e instanceof t)?.[1]}resolveEntities(t,e){return t?Array.from(t.values()).map(i=>this.getComponents(i)).map(i=>i.get(e)):[]}removeSystem(t){this.systems.delete(t)}update(t){this.systems.entries().forEach(([e,i])=>{e.update(i,t)}),this.entitiesToDelete.forEach(e=>{this.deleteEntity(e)}),this.entitiesToDelete=[]}draw(t){this.systems.entries().forEach(([e,i])=>{e.draw?.(i,t)})}deleteEntity(t){this.entities.delete(t),this.systems.values().forEach(e=>{e.delete(t)})}checkEntitySystemMemberships(t){for(let e of this.systems.keys())this.checkEntitySystemMembership(t,e)}checkEntitySystemMembership(t,e){let i=this.entities.get(t),o=this.systems.get(e);!i||!o||(Array.from(e.componentSet).every(r=>i.has(r))?o.add(t):o.delete(t))}};var H=class{color;rect;opacity;constructor(t,e){this.color=e,this.rect=t,this.opacity=1}},at=class{componentSet=new Set([H]);ecs;color;constructor(t){this.color=t}update(){}draw(t,e){t.values().map(o=>this.ecs.getComponents(o)).filter(U).map(o=>o.get(H)).forEach(({rect:o,color:r,opacity:n})=>{n<=0||(n<1&&(e.filter=`opacity(${Math.round(100*n)}%)`),r?e.fillStyle=r:e.fillStyle=this.color,e.fillRect(o.x,o.y,o.width,o.height),e.filter="none")})}};var ct=300/1e3,Kt=1/1e3,me=2/1e3,de=v("./img/ghosty.png"),Wt=24,pe=32;var Vt=class{},Z=class{hp;facing;isNonPhysical;hurtViz;constructor(){this.hp=3,this.facing="left",this.isNonPhysical=!0,this.hurtViz=P(1,250)}},X=class{componentSet=new Set([Vt]);ecs;update(){}},lt=class{componentSet=new Set([Z,y,w]);ecs;update(t,{frameDuration:e}){let i=this.ecs.resolveEntities(this.ecs.querySystem(V),y).map(r=>O(r));Array.from(t.values().map(r=>this.ecs.getComponents(r))).forEach(r=>{let n=r.get(Z),h=O(r.get(y)),a=r.get(w).velocity,[m]=i.reduce(([d,f],E)=>{let S=$(h,E);return S<f?[E,S]:[d,f]},[void 0,1/0]);m&&(m.x<h.x?(a.x=C(-ct,a.x,Kt*e),n.facing="left"):(a.x=C(ct,a.x,Kt*e),n.facing="right"),a.y=C(m.y<h.y?-ct:ct,a.y,me*e))})}draw(t,e){t.values().forEach(i=>{let o=this.ecs.getComponents(i),r=o.get(Z),n=o.get(y);e.drawImage(de,r.facing==="left"?0:Wt,0,Wt,pe,n.x,n.y,n.width,n.height)})}};var w=class{velocity;constructor(t){this.velocity=t}},Y=class{componentSet=new Set([c]);ecs;state="pre-lock";update(t){if(this.state==="pre-lock"){let e=this.ecs.resolveEntities(this.ecs.querySystem(V),y),i=this.ecs.resolveEntities(t,c).filter(o=>o.blocker);if(i.some(o=>e.some(r=>g(o,r))))return;i.forEach(o=>{o.isCollidable=!0}),this.state="locked"}else if(this.state==="locked"){let e=this.ecs.querySystem(X);if(e&&e.size>0)return;t.values().filter(i=>this.ecs.getComponents(i).get(c).blocker).forEach(i=>{this.ecs.removeEntity(i)})}}},J=class{componentSet=new Set([y]);ecs;update(t,{frameDuration:e}){let i=Array.from(t).map(r=>this.ecs.getComponents(r)),o=this.ecs.resolveEntities(this.ecs.querySystem(Y),c);i.forEach(r=>{let n=r.get(y),h=n.isNonPhysical?[]:o;if(r.has(w)){let a=r.get(w).velocity;n.moveX(a.x*e,()=>{},h),n.moveY(a.y*e,()=>{a.y=0},h)}n.isGrounded(o)})}};var Q=class{lifespan;age;constructor(t){this.lifespan=t,this.age=0}},mt=class{componentSet=new Set([H,Q,w]);ecs;update(t,{frameDuration:e}){t.values().forEach(i=>{let o=this.ecs.getComponents(i),r=o.get(Q),n=o.get(H),{velocity:h}=o.get(w);r.age+=e,r.age>=r.lifespan?this.ecs.removeEntity(i):(n.rect.x+=h.x*e,n.rect.y+=h.y*e,n.opacity=1-st(r.age/r.lifespan))})}};function Xt(s,t,e,i,o,r){let n=s.addEntity();return s.addComponent(n,new H({x:t.x-e,y:t.y-e,width:e*2,height:e*2},o)),s.addComponent(n,new w(i)),s.addComponent(n,new Q(r)),n}var ue="a",fe="s",ye="d";var _t=28,Jt=36,ge=28,xe=36,be=250/1e3,we=1.3/1e3,Re=.7,Ee=v("./img/sword_man.png"),Se=(s,t,e)=>{let i=0,o=0;return t==="right"&&(i+=_t),s&&(o+=Jt),e&&(i+=_t*2),{x:i,y:o}},B=class{facing;jumpController;constructor(){this.facing="left",this.jumpController=new nt}},V=class{componentSet=new Set([B,y,w]);ecs;update(t,{frameDuration:e,keyboardState:i}){t.values().map(o=>this.ecs.getComponents(o)).filter(U).forEach(o=>{let r=o.get(y),n=o.get(w).velocity,h=o.get(B),a=(i[ye]?1:0)-(i[ue]?1:0);n.x=C(a*be,n.x,we*e);let{yAcceleration:m,isJumping:d}=h.jumpController.update(i,e,n.y);if(n.y+=m*e,d){let f={x:r.x+r.width/2,y:r.y+r.height},E=2;for(let S=0;S<10;S++){let A=b(-.3,.3);Xt(this.ecs,{x:f.x+A*r.width,y:f.y},E,{x:A*.6,y:b(.05,.11)*(Math.random()<.7?1:-1)},"white",b(140,240))}n.y=-Re}a>0?h.facing="right":a<0&&(h.facing="left"),r.setDropping(i[fe]),h.jumpController.groundedCheck(r.grounded,d)})}draw(t,e){t.values().map(i=>this.ecs.getComponents(i)).filter(U).forEach(i=>{let o=i.get(y),r=i.get(B),n=!1,{x:h,y:a}=Se(n,r.facing,!0);e.drawImage(Ee,h,a,_t,Jt,o.x,o.y,o.width,o.height)})}},qt=(s,t,e)=>{let i=s.addEntity();return s.addComponent(i,new B),s.addComponent(i,new y(t,e,ge,xe)),s.addComponent(i,new w({x:0,y:0})),i};var q=class{loopDuration;start;midpoint;loopState;constructor(t,e,i){this.loopDuration=t,this.start=e,this.midpoint=i,this.loopState=0}},dt=class{componentSet=new Set([c,q]);ecs;update(t,{frameDuration:e}){let i=this.ecs.resolveEntities(this.ecs.querySystem(J),y).filter(r=>!r.isNonPhysical),o=this.ecs.resolveEntities(this.ecs.querySystem(Y),c);t.values().forEach(r=>{let n=this.ecs.getComponents(r),h=n.get(q),a=n.get(c);h.loopState+=e,h.loopState%=h.loopDuration;let m=h.loopState<h.loopDuration/2?h.loopState/h.loopDuration*2:2-h.loopState/h.loopDuration*2,d={x:Mt(h.start.x,h.midpoint.x,m),y:Mt(h.start.y,h.midpoint.y,m)};a.move(d.x-(a.x+a.xRemainder),d.y-(a.y+a.yRemainder),i,o)})}};var L=(s,t)=>{let e=s.x??s.left,i=s.y??s.top,o=s.width??s.right-e,r=s.height??s.bottom-i;if(isNaN(e)||isNaN(i)||isNaN(o)||isNaN(r))throw new Error("Invalid parameters to create solid!");return new c(e,i,o,r,t)},M=(s={})=>{let t=Object.keys(s).filter(e=>s[e]);return t.sort((e,i)=>x[e][0]-x[i][0]),t};var _=s=>{let t=R*3,e=[],i=[],o=p/2-t/2,r=o+t,n=[0].concat(M(s.top).map(l=>x[l][1])),h=M(s.top).map(l=>x[l][0]).concat(p);e.push(...n.map((l,T)=>L({left:l,right:h[T],y:0,height:R}))),i.push(...M(s.top).map(l=>x[l]).map(([l,T])=>L({left:l,right:T,y:0,height:R})));let a=[0].concat(M(s.bottom).map(l=>x[l][1])),m=M(s.bottom).map(l=>x[l][0]).concat(p);e.push(...a.map((l,T)=>L({left:l,right:m[T],y:u-R,height:R}))),e.push(...M(s.bottom).map(l=>L({left:x[l][0],right:x[l][1],top:u-R,height:R/4},{isDroppable:!0}))),i.push(...M(s.bottom).map(l=>x[l]).map(([l,T])=>L({left:l,right:T,y:u-R,height:R})));let d=[0].concat(M(s.left).map(l=>x[l][1])),f=M(s.left).map(l=>x[l][0]).concat(u);e.push(...d.map((l,T)=>L({top:l,bottom:f[T],left:0,width:R}))),i.push(...M(s.left).map(l=>x[l]).map(([l,T])=>L({top:l,bottom:T,x:0,width:R})));let E=[0].concat(M(s.right).map(l=>x[l][1])),S=M(s.right).map(l=>x[l][0]).concat(u);e.push(...E.map((l,T)=>L({top:l,bottom:S[T],left:p-R,width:R}))),i.push(...M(s.right).map(l=>x[l]).map(([l,T])=>L({top:l,bottom:T,x:p-R,width:R})));let A=[];return A.push(L({left:o-t,width:t,top:200,height:R/4},{isDroppable:!0})),A.push(L({left:o,right:r,top:100,height:R/4},{isDroppable:!0})),{blockers:i.map(l=>(l.blocker=!0,l.color="brown",l.isCollidable=!1,l)),solids:e,ladders:A}};var R=15,p=480,u=270,x={high:[40,80],medium:[u/2-20,u/2+20],low:[u-80,u-40],left:[80,180],center:[p/2-50,p/2+50],right:[p-180,p-80]},zt=["left","center","right"],jt=["high","medium","low"],D=class{getDoorwayChance(){return .5}static getDoorArrangement(){return{top:{},bottom:{},left:{},right:{}}}static isValidAt(t,e){return!0}static areDoorsOk(t){let e=this.getDoorArrangement();return jt.every(i=>(e.left[i]===void 0||t.left[i]===void 0||e.left[i]===t.left[i])&&(e.right[i]===void 0||t.right[i]===void 0||e.right[i]===t.right[i]))&&zt.every(i=>(e.top[i]===void 0||t.top[i]===void 0||e.top[i]===t.top[i])&&(e.bottom[i]===void 0||t.bottom[i]===void 0||e.bottom[i]===t.bottom[i]))}x;y;width;height;color;blockersLocked;allEnemiesCleared;doors;ecs;roomCollider;exits;constructor(t,e,i,o,r="blue",n={}){this.x=t,this.y=e,this.width=i,this.height=o,this.roomCollider={x:0,y:0,width:i*p,height:o*u},this.exits=[],this.setupExits(),this.ecs=new ht,this.ecs.addSystem(new J),this.ecs.addSystem(new Y),this.ecs.addSystem(new at(r)),this.ecs.addSystem(new V),this.ecs.addSystem(new dt),this.ecs.addSystem(new X),this.ecs.addSystem(new lt),this.ecs.addSystem(new mt),this.color=r,this.blockersLocked=!1,this.allEnemiesCleared=!1,this.doors={left:n.left??{},right:n.right??{},top:n.top??{},bottom:n.bottom??{}},this.globalDoorwayRectification(),this.configureAllDoors(),this.configureRoomContent(),qt(this.ecs,.5*p,.08*u)}setupExits(){for(let e=0;e<this.width;e++)this.exits.push({collider:{x:e*p,y:-100,width:p,height:100},roomPos:{x:this.x+e,y:this.y-1},direction:"top"});for(let e=0;e<this.width;e++)this.exits.push({collider:{x:e*p,y:this.height*u,width:p,height:100},roomPos:{x:this.x+e,y:this.y+this.height},direction:"bottom"});for(let e=0;e<this.height;e++)this.exits.push({collider:{x:-100,y:e*u,width:100,height:u},roomPos:{x:this.x-1,y:this.y+e},direction:"left"});for(let e=0;e<this.height;e++)this.exits.push({collider:{x:this.width*p,y:e*u,width:100,height:u},roomPos:{x:this.x+this.width,y:this.y+e},direction:"right"})}globalDoorwayRectification(){this.x===0&&this.y===0?this.doors={bottom:{center:!0,left:!1,right:!1},top:{center:!1,left:!1,right:!1},left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1}}:this.x===0&&this.y===1?this.doors.top={center:!0,left:!1,right:!1}:this.y===1&&(this.doors.top={center:!1,left:!1,right:!1})}configureAllDoors(){let t=this.constructor.getDoorArrangement(),e=this.getDoorwayChance();jt.forEach(i=>{this.doors.left[i]===void 0&&(this.doors.left[i]=t.left[i]??Math.random()<e),this.doors.right[i]===void 0&&(this.doors.right[i]=t.right[i]??Math.random()<e)}),zt.forEach(i=>{this.doors.top[i]===void 0&&(this.doors.top[i]=t.top[i]??Math.random()<e),this.doors.bottom[i]===void 0&&(this.doors.bottom[i]=t.bottom[i]??Math.random()<e)})}configureRoomContent(){let{solids:t,blockers:e,ladders:i}=_(this.doors);t.concat(e).concat(i).forEach(n=>{let h=this.ecs.addEntity();this.ecs.addComponent(h,n),this.ecs.addComponent(h,new H(n,n.color))});let o=this.ecs.addEntity(),r=new c(220,140,100,15);this.ecs.addComponent(o,r),this.ecs.addComponent(o,new H(r,this.color)),this.ecs.addComponent(o,new q(7e3,{x:220,y:140},{x:300,y:140}))}draw(t,e,i,o){t.fillStyle="black",t.fillRect(0,0,e.width,e.height),this.ecs.draw(t)}update(t,e,i,o){this.ecs.update({mousePosition:t,keyboardState:e,frameDuration:i}),this.validateLeavingRoom(o)}validateLeavingRoom(t){let i=Array.from(this.ecs.querySystem(V)?.values()??[]).map(d=>this.ecs.getComponents(d))[0];if(!i)throw new Error("No player found.");let o=i.get(y),r=O(o);if(G(this.roomCollider,r.x,r.y))return;let n=this.exits.find(d=>G(d.collider,r.x,r.y));if(!n)throw new Error("Player outside of room collider but has not hit any exit!");let{direction:h,roomPos:a}=n,m=h==="top"||h==="bottom"?{[h==="top"?"bottom":"top"]:{[["left","center","right"].find(d=>r.x>=x[d][0]&&r.x<x[d][1])]:!0}}:{[h==="left"?"right":"left"]:{[["low","medium","high"].find(d=>r.y>=x[d][0]&&r.y<x[d][1])]:!0}};t(a.x,a.y,m)}setExternalMatchingDoorways(t){let e={};for(let i in t){let o=i;for(let r in t[o]){let n=r;if(o==="left"||o==="right"){let h=r;t[o][h]===!1&&this.doors[o][h]===!0&&(e[o]=e[o]??{},e[o][h]=!0)}else{let h=r;t[o][h]===!1&&this.doors[o][h]===!0&&(e[o]=e[o]??{},e[o][h]=!0)}}}}drawForMap(t){t.fillStyle=this.color;let e=this.ecs.resolveEntities(this.ecs.querySystem(Y),c);for(let i of e)i.blocker||t.fillRect(i.x,i.y,i.width,i.height)}};var z=class{x;y;width;height;color;xVelocity;yVelocity;lifeLeft;lifespan;alive;affectedByGravity;constructor(t,e,i,o,r,n,h,a,m=!1){this.x=t,this.y=e,this.width=i,this.height=o,this.color=r,this.xVelocity=n,this.yVelocity=h,this.lifeLeft=a,this.lifespan=a,this.alive=!0,this.affectedByGravity=m}draw(t){t.filter=`opacity(${Math.round(100*this.lifeLeft/this.lifespan)}%)`,t.fillStyle=this.color,t.fillRect(Math.round(this.x),Math.round(this.y),this.width,this.height),t.filter="none"}update(t){this.affectedByGravity&&(this.yVelocity+=t*.0025),this.x+=t*this.xVelocity,this.y+=t*this.yVelocity,this.lifeLeft=Math.max(0,this.lifeLeft-t),this.lifeLeft<=0&&(this.alive=!1)}};var Ce=200,k=120,$t=500/1e3,It=v("./img/theghost.png"),De={x:100,y:100,width:p-200,height:u-200},Zt={x:-100,y:-100,width:p+200,height:u+200},pt=class{hp;alive;isNonPhysical;facing;x;y;xVelocity=0;yVelocity=0;collider;hurtVisualiser;particleCooldown;strategy;isStrategyComplete;distFromStart;distFromTarget;constructor(t,e){this.hp=20,this.alive=!0,this.isNonPhysical=!1,this.facing="left",this.x=t,this.y=e,this.collider={x:this.x-k/2,y:this.y-k/2,width:k,height:k},this.hurtVisualiser=P(1,250),this.particleCooldown=P(1,40),this.strategy="initialWait",this.isStrategyComplete=!1,this.distFromStart=()=>0,this.distFromTarget=()=>0}update(t,e,i){switch(this.hurtVisualiser.down(t),this.particleCooldown.down(t),this.strategy){case"initialWait":G(De,i.x,i.y)&&this.initFlee(i);return;case"flee":let o=.8+Math.min(1.2,this.distFromStart()/600);this.collider.x+=this.xVelocity*t*o,this.collider.y+=this.yVelocity*t*o,g(Zt,this.collider)||this.initCharge(i),this.addParticle(e);return;case"charge":let r=.8+Math.min(1.2,this.distFromTarget()/600);this.collider.x+=this.xVelocity*t*r,this.collider.y+=this.yVelocity*t*r,this.distFromTarget()<=10&&this.initFlee(i),this.addParticle(e);return}}addParticle(t){if(this.particleCooldown.check()<=0){let e=Ut(this.collider),i=4;t.addParticle(new z(e.x-i/2,e.y-i/2,4,4,"white",this.xVelocity*.3,this.yVelocity*.3,360,!1)),this.particleCooldown.up(1)}}initFlee(t){this.strategy="flee";let e=O(this.collider),i={x:t.x-e.x,y:t.y-e.y},o=At(i,$t);this.xVelocity=o.x,this.yVelocity=o.y,this.distFromStart=()=>$(O(this.collider),e)}initCharge(t){this.strategy="charge";let e=Gt(Zt);this.collider.x=e.x-k/2,this.collider.y=e.y-k/2;let i=t.x,o=t.y,r={x:i-e.x,y:o-e.y},n=At(r,$t);this.xVelocity=n.x,this.yVelocity=n.y,this.distFromTarget=()=>{let h=O(this.collider);return $(h,{x:i,y:o})}}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(10000%) saturate(0%)");let e=Math.round(this.collider.x),i=Math.round(this.collider.y),o=(Ce-k)/2;t.drawImage(It,0,0,It.width,It.height,e-o,i-o,this.collider.width+2*o,this.collider.height+2*o),t.filter="none",!1}applyDamage(t){this.hp-=1,this.hurtVisualiser.up(1),this.hp<0&&(this.alive=!1)}intersects(t){if(g(t,this.collider))return this.collider}};var ut=class extends D{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!0,medium:!1,low:!1},right:{high:!0,medium:!1,low:!1},bottom:{left:!1,center:!1,right:!1},top:{left:!1,center:!1,right:!1}}}static isValidAt(){return!0}configureRoomContent(){let{solids:t,blockers:e}=_(this.doors);this.solids=t.concat(e).concat(...[240,390,540].map(i=>new c(40,i,p-80,10,{isDroppable:!0}))),this.enemies=[new pt(p/2,u/2)]}};var ft=class extends D{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1},bottom:{left:!0,center:!1,right:!0},top:{left:!0,center:!1,right:!0}}}static isValidAt(t,e){return e>=2}configureRoomContent(){let{blockers:t}=_(this.doors);this.solids=t.concat(new c(0,0,80,u),new c(p-80,0,80,u),new c(280,0,720,260),new c(280,460,720,260),new c(80,u-40,200,10,{isDroppable:!0}),new c(120,570,120,10,{isDroppable:!0}),new c(80,460,200,10,{isDroppable:!0}),new c(80,120,200,10,{isDroppable:!0}),new c(80,250,200,10,{isDroppable:!0}),new c(80,355,100,10,{isDroppable:!0}),new c(1e3,u-40,200,10,{isDroppable:!0}),new c(1040,570,120,10,{isDroppable:!0}),new c(1e3,460,200,10,{isDroppable:!0}),new c(1e3,120,200,10,{isDroppable:!0}),new c(1e3,250,200,10,{isDroppable:!0}),new c(1100,355,100,10,{isDroppable:!0}))}};var yt=class extends D{getDoorwayChance(){return .1}static getDoorArrangement(){return{left:{},right:{high:!1,medium:!1,low:!0},bottom:{},top:{left:!0,center:!1,right:!1}}}static isValidAt(t,e){return e>=2}configureRoomContent(){let{solids:t,blockers:e}=_(this.doors);this.solids=t.concat(e).concat(new c(380,0,p-380,450),new c(120,140,120,10,{isDroppable:!0}),new c(40,240,340,10,{isDroppable:!0}),new c(this.doors?.left?.center?160:40,340,this.doors.left.center?220:340,10,{isDroppable:!0}),new c(40,440,340,10,{isDroppable:!0}),new c(40,this.doors.left.low?550:540,240,10,{isDroppable:!0}))}};var Qt=340,Ot=76,te=60,ee=80,gt=2.5/1e3,Pt=v("./img/spitboss-head.png"),Ht=v("./img/spitboss-base.png"),Lt=v("./img/spitboss-spit.png"),xt=class{hp;alive;isNonPhysical;x;y;baseBox;headBox;hurtVisualiser;fireCooldown;constructor(t,e){this.hp=50,this.alive=!0,this.isNonPhysical=!1,this.x=t,this.y=e,this.baseBox={x:this.x-Qt/2,y:this.y-Ot,width:Qt,height:Ot},this.headBox={x:this.x-te/2,y:Math.round(this.y-ee-.75*Ot),width:te,height:ee},this.hurtVisualiser=P(1,250),this.fireCooldown=P(1,1200)}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(1000%) saturate(0%)");let e=8,i=8;t.drawImage(Ht,0,0,Ht.width,Ht.height,this.baseBox.x-e,this.baseBox.y-i,this.baseBox.width+2*e,this.baseBox.height+i);let o=4;t.drawImage(Pt,0,0,Pt.width,Pt.height,this.headBox.x-o,this.headBox.y-o,this.headBox.width+2*o,this.headBox.height+2*o),t.filter="none",!1}update(t,e,i){if(this.hurtVisualiser.down(t),this.fireCooldown.down(t),this.fireCooldown.check()===0){let o=this.createProjectile(e,i);o&&o.length>0&&(this.fireCooldown.up(1),e.enemies.push(...o))}}createProjectile(t,e){let i={x:this.x-5,width:10,y:0,height:this.y},r=t.solids.filter(A=>A.isCollidable&&!A.isDroppable&&g(A,i)).reduce((A,l)=>Math.max(A,l.y+l.height),0),n=this.y-100,h=n-r-et,a=-Math.sqrt(2*gt*h);if(e.y<=h)return;let m=b(.8,1)*a,d=m*m-2*gt*(n-e.y);if(d<=0)return;let f=(-m+Math.sqrt(d))/gt,E=(e.x-this.x)/f,S=W(1,4);return new Array(S).fill(0).map(()=>new Ft(this.x,n,E+b(-.1,.1),m+b(-.01,.1),this))}applyDamage(t){t===this.headBox?(this.hp-=3,this.hurtVisualiser.up(1)):t===this.baseBox&&(this.hp-=.2,this.hurtVisualiser.up(.2)),this.hp<0&&(this.alive=!1)}intersects(t){if(g(t,this.headBox))return this.headBox;if(g(t,this.baseBox))return this.baseBox}},et=14,Ft=class{actor;xVelocity;yVelocity;parent;alive;struck;hitVisualiser;constructor(t,e,i,o,r){this.actor=new y(t-et,e-et,et*2,et*2),this.xVelocity=i,this.yVelocity=o,this.parent=r,this.alive=!0,this.struck=!1,this.hitVisualiser=P(1,150)}draw(t){t.drawImage(Lt,0,0,Lt.width,Lt.height,this.actor.x-2,this.actor.y-2,this.actor.width+4,this.actor.height+4)}addParticle(t,e,i){t.addParticle(new z(e.x-3,e.y-3,6,6,Math.random()>.5?"#674cd3":"#9e5eff",i.x,i.y,b(120,200),!0))}update(t,e,i){this.hitVisualiser.down(t);let o=r=>n=>{this.alive=!1;let h=r==="x"?{x:this.xVelocity>0?n.x:n.x+n.width,y:this.actor.y+this.actor.height/2}:{x:this.actor.x+this.actor.width/2,y:this.yVelocity>0?n.y:n.y+n.height};for(let a=0;a<12;a++){let m=r==="x"?{x:-this.xVelocity*b(.4,.6),y:b(-.2,.2)}:{x:b(-.2,.2),y:-this.yVelocity*b(.2,.3)};this.addParticle(e,h,m)}};if(this.yVelocity+=gt*t,this.actor.moveX(this.xVelocity*t,o("x"),e.solids),this.actor.moveY(this.yVelocity*t,o("y"),e.solids),this.struck&&this.parent.alive){let r=this.parent.intersects(this.actor);if(r){this.parent.applyDamage(r);let n=Yt(O(this.actor),rt(r,16));for(let h=0;h<12;h++){let a={x:-this.xVelocity*b(.4,.6)+b(-.2,.2),y:-this.yVelocity*b(.2,.3)+b(-.2,.2)};this.addParticle(e,n,a)}this.alive=!1}}}applyDamage(t,e){this.hitVisualiser.up(1),this.xVelocity=e?.x??0,this.yVelocity=e?.y??0,this.struck=!0}intersects(t){if(g(t,this.actor))return this.actor}};var bt=class extends D{getDoorwayChance(){return .1}static getDoorArrangement(){return{left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1},bottom:{left:!1,center:!1,right:!1},top:{left:!1,center:!0,right:!1}}}static isValidAt(t,e){return!0}configureRoomContent(){let{solids:t,blockers:e}=_(this.doors);this.solids=t.concat(e).concat(new c(320,160,920,40),new c(840,0,440,200),new c(0,0,80,u),new c(p-80,0,80,u),new c(0,u-80,p,80),new c(80,160,240,10,{isDroppable:!0})),this.enemies=[new xt(780,u-80)]}onAllEnemiesCleared(){super.onAllEnemiesCleared(),this.solids=this.solids.concat(...[320,480].map(t=>new c(80,t,240,10,{isDroppable:!0})))}};var wt=300/1e3,ie=1/1e3,oe=2/1e3,Te=v("./img/ghosty.png"),Nt=24,se=32,re=2,Rt=class{xVelocity;yVelocity;actor;hp;alive;facing;isNonPhysical;hurtVisualiser;constructor(t,e){this.xVelocity=0,this.yVelocity=0,this.actor=new y(t,e,Nt*re,se*re),this.hp=3,this.alive=!0,this.facing="left",this.isNonPhysical=!0,this.hurtVisualiser=P(1,250)}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(1000%) saturate(0%)"),t.drawImage(Te,this.facing==="left"?0:Nt,0,Nt,se,this.actor.x,this.actor.y,this.actor.width,this.actor.height),t.filter="none",!1}update(t,e,i){this.updateVelocities(t,e,i),this.isNonPhysical?(this.actor.moveX(this.xVelocity*t,()=>{},[]),this.actor.moveY(this.yVelocity*t,()=>{},[])):(this.actor.moveX(this.xVelocity*t,()=>{this.xVelocity=0},e.solids),this.actor.moveY(this.yVelocity*t,()=>{this.yVelocity=0},e.solids)),this.hurtVisualiser.down(t)}updateVelocities(t,e,i){let o=this.actor.getMidpoint();i?(i.x<o.x?(this.xVelocity=C(-wt,this.xVelocity,ie*t),this.facing="left"):(this.xVelocity=C(wt,this.xVelocity,ie*t),this.facing="right"),i.y<o.y?this.yVelocity=C(-wt,this.yVelocity,oe*t):this.yVelocity=C(wt,this.yVelocity,oe*t)):this.facing=this.xVelocity<0?"left":"right"}applyDamage(t,e){this.hp-=1,this.xVelocity+=e?.x??0,this.yVelocity+=e?.y??0,this.hp<=0&&(this.alive=!1),this.hurtVisualiser.up()}intersects(t){if(g(t,this.actor))return this.actor}};var ne=180/1e3,it=2/1e3,Me=2.5/1e3,ot=class extends Rt{constructor(t,e){super(t,e),this.hp=5,this.isNonPhysical=!1,this.facing="left"}updateVelocities(t,e,i){this.yVelocity+=Me*t;let o={x:this.actor.x,y:this.actor.y+this.actor.height,width:this.actor.width,height:1};e.solids.some(r=>r.isCollidable&&g(r,o))||(this.xVelocity=C(0,this.xVelocity,it/2)),this.facing==="left"?this.canMoveLeft(e)?this.xVelocity=C(-ne,this.xVelocity,it):this.canMoveRight(e)&&(this.facing="right",this.xVelocity=C(0,this.xVelocity,it)):this.canMoveRight(e)?this.xVelocity=C(ne,this.xVelocity,it):this.canMoveLeft(e)&&(this.facing="left",this.xVelocity=C(0,this.xVelocity,it))}canMoveLeft(t){let e={x:this.actor.x-this.actor.width/2,y:this.actor.y+this.actor.height,width:this.actor.width/4,height:1},i={x:this.actor.x-this.actor.width,y:this.actor.y,height:this.actor.height,width:this.actor.width};return t.solids.some(o=>o.isCollidable&&!o.isDroppable&&g(o,e))&&t.solids.every(o=>!o.isCollidable||!g(o,i))}canMoveRight(t){let e={x:this.actor.x+this.actor.width/4*5,y:this.actor.y+this.actor.height,width:this.actor.width/4,height:1},i={x:this.actor.x+this.actor.width,y:this.actor.y,height:this.actor.height,width:this.actor.width};return t.solids.some(o=>o.isCollidable&&!o.isDroppable&&g(o,e))&&t.solids.every(o=>!o.isCollidable||o.isDroppable||!g(o,i))}applyDamage(t,e){super.applyDamage(t,e),this.yVelocity-=.3}};var Et=class extends D{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!0,medium:!1,low:!1},right:{high:!0,medium:!1,low:!1},bottom:{left:!1,center:!0,right:!1},top:{}}}configureRoomContent(){let{solids:t,blockers:e}=_(this.doors);this.solids=t.concat(e).concat(new c(0,240,440,u-240),new c(840,240,p-840,u-240),new c(440,240,400,10,{isDroppable:!0}),new c(440,380,400,10,{isDroppable:!0}),new c(440,520,400,10,{isDroppable:!0})).concat(...[this.doors.top.left?new c(120,120,120,10,{isDroppable:!0}):void 0,this.doors.top.center?new c(580,120,120,10,{isDroppable:!0}):void 0,this.doors.top.right?new c(1040,120,120,10,{isDroppable:!0}):void 0].filter(U)),this.enemies=[new ot(p/4,176),new ot(p*3/4,176)]}};var K=128,j=72,he=9,ae=6,ce=1/10,le=4,St=class{lastRoomIndex;map;x;y;currentIndex;minX;minY;canvas;ctx;constructor(){this.lastRoomIndex={x:0,y:0},this.map={},this.x=0,this.y=0,this.currentIndex=this.index(0,0),this.minX=0,this.minY=0;let t=new D(0,0,1,1);this.map[this.index(0,0)]=t;let e=Math.max(he),i=Math.max(ae);this.canvas=new OffscreenCanvas(e*K,i*j);let o=this.canvas.getContext("2d");if(!o)throw Error("Could not construct canvas");this.ctx=o,this.redrawWorldMap()}createNewCanvas(t,e,i,o){let r=Math.max(he,e-t+1+le),n=Math.max(ae,o-i+1+le);this.canvas=new OffscreenCanvas(r*K,n*j);let h=this.canvas.getContext("2d");if(!h)throw Error("Could not construct canvas");this.ctx=h}getNeighboringDoors(t,e){return{right:{...this.map[this.index(t+1,e)]?.doors?.left},left:{...this.map[this.index(t-1,e)]?.doors?.right},top:{...this.map[this.index(t,e-1)]?.doors?.bottom},bottom:{...this.map[this.index(t,e+1)]?.doors?.top}}}generateRoomChoices(t,e,i={}){let o=()=>`hsl(${W(0,360)}, 60%, 60%)`,r=()=>({left:{...i.left??{}},right:{...i.right??{}},top:{...i.top??{}},bottom:{...i.bottom??{}}}),n=[ut,ft,yt,Et,bt],h=r(),a=n.filter(d=>d.isValidAt(t,e)&&d.areDoorsOk(h));a.push(D,D,D);let m=[];for(let d=0;d<3;d++){let f=a.shift();if(!f)throw new Error("Could not find enough rooms");m.push(new f(t,e,1,1,o(),r()))}return m}redrawWorldMap(){let t=0,e=0;for(let i of Object.values(this.map))this.minX=Math.min(this.minX,i.x),t=Math.max(t,i.x),this.minY=Math.min(this.minY,i.y),e=Math.max(e,i.y);(t-this.minX+1>this.canvas.width/K||e-this.minY+1>this.canvas.height/j)&&this.createNewCanvas(this.minX,t,this.minY,e),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let i of Object.values(this.map))this.ctx.save(),this.ctx.translate((i.x-this.minX)*K,(i.y-this.minY)*j),this.ctx.scale(ce,ce),i.drawForMap(this.ctx),this.ctx.restore()}drawMapToScreen(t,e,i,o,r){let a=Math.min(o,this.canvas.width),m=Math.min(r,this.canvas.height),d=(-this.minX+this.x+1/2)*K-o/2;t.drawImage(this.canvas,d,0,a,m,e,i,a,m),t.fillStyle="white";let f=rt({x:-d+(this.x-this.minX+1/2)*K,y:i+this.y*j,width:K,height:j},-2),E=f.x+f.width,S=f.y+f.height;t.fillRect(...N(F({left:f.x,width:10,top:f.y,height:2}))),t.fillRect(...N(F({left:f.x,width:2,top:f.y,height:10}))),t.fillRect(...N(F({right:E,width:10,top:f.y,height:2}))),t.fillRect(...N(F({right:E,width:2,top:f.y,height:10}))),t.fillRect(...N(F({left:f.x,width:10,bottom:S,height:2}))),t.fillRect(...N(F({left:f.x,width:2,bottom:S,height:10}))),t.fillRect(...N(F({right:E,width:10,bottom:S,height:2}))),t.fillRect(...N(F({right:E,width:2,bottom:S,height:10})))}index(t,e){return`${t},${e}`}getCurrentRoom(){return this.map[this.currentIndex]}getPreviousRoom(){return this.map[this.index(this.lastRoomIndex.x,this.lastRoomIndex.y)]}hasRoom(t,e){return this.index(t,e)in this.map}enterRoom(t,e){this.lastRoomIndex={x:this.x,y:this.y},this.x=t,this.y=e,this.currentIndex=this.index(t,e),this.redrawWorldMap()}addRoom(t){if(this.map[this.currentIndex])throw new Error("Adding room where we already have one!");this.map[this.currentIndex]=t,this.map[this.index(this.x-1,this.y)]?.setExternalMatchingDoorways?.({right:t.doors.left}),this.map[this.index(this.x+1,this.y)]?.setExternalMatchingDoorways?.({left:t.doors.right}),this.map[this.index(this.x,this.y-1)]?.setExternalMatchingDoorways?.({bottom:t.doors.top}),this.map[this.index(this.x,this.y+1)]?.setExternalMatchingDoorways?.({top:t.doors.bottom}),t.setExternalMatchingDoorways({left:this.map[this.index(this.x-1,this.y)]?.doors?.right,right:this.map[this.index(this.x+1,this.y)]?.doors?.left,top:this.map[this.index(this.x,this.y-1)]?.doors?.bottom,bottom:this.map[this.index(this.x,this.y+1)]?.doors?.top}),this.redrawWorldMap()}};var Ct=10,Ae="Tab",I=64,Dt=4,Tt=class{worldMap;lastFrameTime;unprocessedTime;pausedFor;choosing;choices;tabLatch;mouseOverChoiceIndex;firstTickInNewRoom;constructor(){this.worldMap=new St,this.lastFrameTime=performance.now(),this.unprocessedTime=0,this.pausedFor=void 0,this.choosing=!0,this.choices=[],this.tabLatch=kt(!1),this.mouseOverChoiceIndex=-1,this.firstTickInNewRoom=!1}update(t,e,i,o){if(this.tabLatch(!!o[Ae],{onLock:()=>{this.pausedFor==="Tab"?(this.lastFrameTime=performance.now(),this.pausedFor=void 0):this.pausedFor||(this.pausedFor="Tab")}}),this.pausedFor==="choices"){this.choices.length===0&&(this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y)),this.draw(t,e,i,0),this.drawMap(t,e),this.drawOptions(t,e,i);return}else if(this.pausedFor==="Tab"){this.draw(t,e,i,0),this.drawMap(t,e);return}let r=performance.now(),n=this.firstTickInNewRoom?0:Math.min(r-this.lastFrameTime,250);for(this.lastFrameTime=r,this.firstTickInNewRoom=!1,this.unprocessedTime+=n;this.unprocessedTime>=Ct&&!this.pausedFor;)this.simulateFrame(i,o),this.unprocessedTime-=Ct;this.pausedFor&&(this.unprocessedTime=0);let h=this.unprocessedTime/Ct;this.draw(t,e,i,h)}drawMap(t,e){t.fillStyle="#00000099",t.fillRect(0,0,e.width,e.height),t.fillStyle="white",t.fillRect(I-Dt,I-Dt,e.height-(I-Dt)*2,e.height-(I-Dt)*2),t.fillStyle="black",t.fillRect(I,I,e.height-I*2,e.height-I*2),this.worldMap.drawMapToScreen(t,I,I,e.height-I*2,e.height-I*2)}click(t,e){let i=this.pausedFor==="choices"&&this.choices.length>0,o=this.mouseOverChoiceIndex>=0&&this.mouseOverChoiceIndex<this.choices.length;if(i&&o){let r=this.choices[this.mouseOverChoiceIndex];this.worldMap.addRoom(r);let n=this.worldMap.getPreviousRoom();this.transferPlayerPosition(n,r),this.unprocessedTime=0,this.firstTickInNewRoom=!0,this.pausedFor=void 0,this.choices=[]}}transferPlayerPosition(t,e){let i=t.ecs.querySystem(V),o=e.ecs.querySystem(V);if(i?.size!==1||o?.size!==1)return;let r=t.ecs.getComponents(Array.from(i.values())[0]),n=e.ecs.getComponents(Array.from(o.values())[0]);if(!r||!n)return;let h=r.get(y),a=n.get(y),m=r.get(w).velocity,d=n.get(w).velocity;d.x=m.x,d.y=Math.min(m.y,.1);let f=h.x+t.x*p,E=h.y+t.y*u;a.x=f-e.x*p,a.y=E-e.y*u,e.y>=t.y+t.height?d.y=Math.min(d.y,1):e.y+e.height<=t.y&&(d.y=Math.min(-1.1,d.y)),n.get(B).facing=r.get(B).facing}simulateFrame(t,e){this.worldMap.getCurrentRoom().update(t,e,Ct,this.onRoomChange.bind(this))}onRoomChange(t,e,i){this.worldMap.hasRoom(t,e)?(this.worldMap.enterRoom(t,e),this.transferPlayerPosition(this.worldMap.getPreviousRoom(),this.worldMap.getCurrentRoom())):(this.pausedFor="choices",this.worldMap.enterRoom(t,e),this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y,i))}draw(t,e,i,o){let r=this.worldMap.getCurrentRoom();r&&(t.save(),t.scale(2,2),r.draw(t,e,i,o),t.restore())}drawOptions(t,e,i){this.mouseOverChoiceIndex=-1;for(let o=0;o<this.choices.length;o++){let r=this.choices[o],n=e.height,h=e.width,a=(n+h)/2,m=e.height/this.choices.length,d=m*o,f=d+m;t.save(),t.translate(a,(d+f)/2);let E=i&&G({x:n,y:d,width:h-n,height:m},i.x,i.y),S=(h-n)/p*.5;t.scale(S,S),E&&(this.mouseOverChoiceIndex=o,t.scale(1.1,1.1)),t.translate(-p/2,-u/2),r.drawForMap(t),t.restore()}}};function ve(){let s=document.getElementById("canvas");if(!s){console.error("Could not find canvas");return}let t=s.getContext("2d");if(!t)throw Error("Could not set up canvas rendering context");t.imageSmoothingEnabled=!1;let e=new Tt,i;s.addEventListener("mousemove",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,m=n.clientY-h.top;i={x:a,y:m}}),s.addEventListener("mouseleave",()=>{i=void 0}),s.addEventListener("click",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,m=n.clientY-h.top;i={x:a,y:m},e.click(s,i)});let o={};window.addEventListener("keydown",n=>{o[n.key]=!0,(n.key==="Tab"||n.key===" ")&&n.preventDefault()}),window.addEventListener("keyup",n=>{delete o[n.key]}),window.addEventListener("blur",()=>{o={}});function r(){e.update(t,s,i,o),requestAnimationFrame(r)}r()}document.addEventListener("DOMContentLoaded",()=>{ve()});})();
//# sourceMappingURL=index.js.map
