"use strict";(()=>{var _t=s=>{let t=s;return(e,{onLock:i,onRelease:o})=>{e!==t&&(t=e,e?i&&i():o&&o())}},A=(s,t)=>{let e=0;return{up(i=1){e=Math.min(1,e+i/s)},down(i=1){e=Math.max(0,e-i/t)},check(){return e}}};function St(s,t,e){return(1-e)*s+e*t}function K(s,t){return Math.floor((t-s)*Math.random())}function R(s,t){return s+Math.random()*(t-s)}function u(s,t){return!(s.x>=t.x+t.width||t.x>=s.x+s.width||s.y>=t.y+t.height||t.y>=s.y+s.height)}function tt(s,t,e){return s.x<=t&&t<s.x+s.width&&s.y<=e&&e<s.y+s.height}function Pt(s){return s*s}function b(s,t,e){return s>t?Math.min(s,t+e):s<t?Math.max(s,t-e):s}function Ot(s,t,e){return Math.max(t,Math.min(s,e))}function Lt(s,t){return{x:Ot(s.x,t.x,t.x+t.width),y:Ot(s.y,t.y,t.y+t.height)}}function Ht(s,t){return{x:s.x+t,y:s.y+t,width:s.width-2*t,height:s.height-2*t}}function P(s){return{x:s.x+s.width/2,y:s.y+s.height/2}}function Rt(s,t){let e=Math.sqrt(s.x*s.x+s.y*s.y);return{x:s.x*t/e,y:s.y*t/e}}function z(s,t){return Math.sqrt(Pt(s.x-t.x)+Pt(s.y-t.y))}function Ft(s){let t=s.width+s.height,e=R(0,t);return e<s.width?{x:s.x+e,y:K(0,2)?s.y:s.y+s.height}:{x:K(0,2)?s.x:s.x+s.width,y:s.y+(e-s.width)}}function Yt(s){return{x:s.x+R(0,s.width),y:s.y+R(0,s.height)}}var c=class{x;y;height;width;isCollidable;isDroppable;color;xRemainder;yRemainder;blocker;constructor(t,e,i,o,r={}){this.x=t,this.y=e,this.width=i,this.height=o,this.isCollidable=!0,this.isDroppable=r.isDroppable??!1,this.blocker=!1,this.xRemainder=0,this.yRemainder=0}move(t,e,i,o){this.xRemainder+=t,this.yRemainder+=e;let r=Math.round(this.xRemainder),n=Math.round(this.yRemainder);if(r!==0||n!==0){let h=i.filter(a=>a.isRiding(this));if(this.isCollidable=!1,r!==0){if(this.xRemainder-=r,this.x+=r,r>0)for(let a of i)u(this,a)?a.moveX(this.x+this.width-a.x,a.squish,o):h.some(m=>m===a)&&a.moveX(r,()=>{},o);else if(r<0)for(let a of i)u(this,a)?a.moveX(this.x-(a.x+a.width),a.squish,o):h.some(m=>m===a)&&a.moveX(r,()=>{},o)}this.isCollidable=!0}}};var f=class{x;y;width;height;xRemainder;yRemainder;isDropping;droppingSet;grounded;isNonPhysical;constructor(t,e,i,o){this.x=t,this.y=e,this.width=i,this.height=o,this.xRemainder=0,this.yRemainder=0,this.isDropping=!1,this.droppingSet=new Set,this.grounded=!1,this.isNonPhysical=!1}setDropping(t){this.isDropping=!!t,this.droppingSet=new Set(Array.from(this.droppingSet).filter(e=>u(this,e)))}moveX(t,e,i){this.xRemainder+=t;let o=Math.round(this.xRemainder);if(o!==0){this.xRemainder-=o;let r=o>0?1:-1;for(;o!==0;){this.x+=r,o-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(i);if(h.forEach(a=>{this.droppingSet.add(a)}),n){this.x-=r,e(n);break}}}}moveY(t,e,i){this.yRemainder+=t;let o=Math.round(this.yRemainder);if(o!==0){this.yRemainder-=o;let r=o>0?1:-1;for(;o!==0;){this.y+=r,o-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(i);if((r<0||this.isDropping)&&h.length>0?h.forEach(a=>this.droppingSet.add(a)):h.length>0&&(n=h[0]),n){this.y-=r,e(n);break}}}}isGrounded(t){let e={x:this.x,y:this.y+this.height,width:this.width,height:1},i=t.find(o=>this.droppingSet.has(o)||this.isDropping&&o.isDroppable?!1:u(e,o));return this.grounded=!!i,this.grounded}collideAt(t){let e=[];return{collidingSolid:t.find(o=>!o.isCollidable||!u(this,o)?!1:o.isDroppable?(this.droppingSet.has(o)||e.push(o),!1):!0),droppingThroughSolids:e}}isRiding(t){return u(t,{x:this.x,y:this.y+this.height,width:this.width,height:1})}squish(){console.log("Squish")}getMidpoint(){return{x:this.x+this.width/2,y:this.y+this.height/2}}};var D=s=>{let t=new Image;return t.src=s,t};function H(s){return s!=null}var et=class{isGrounded;coyoteTime;timeSinceJumpPress;isJumpKeyDown;stillHoldingJump;constructor(){this.isGrounded=!1,this.coyoteTime=0,this.timeSinceJumpPress=200,this.isJumpKeyDown=!1,this.stillHoldingJump=!1}update(t,e,i){this.coyoteTime-=e,t[" "]?this.isJumpKeyDown?this.timeSinceJumpPress+=e:(this.isJumpKeyDown=!0,this.timeSinceJumpPress=0):(this.stillHoldingJump=!1,this.isJumpKeyDown=!1,this.timeSinceJumpPress=200);let r=this.isJumpKeyDown&&this.timeSinceJumpPress<100&&(this.isGrounded||this.coyoteTime>0);return r&&(this.stillHoldingJump=!0,this.timeSinceJumpPress=200,this.coyoteTime=0),{isJumping:r,yAcceleration:this.getGravity(i)}}getGravity(t){return t>-.5||!this.stillHoldingJump?.006:.0025}groundedCheck(t,e){this.isGrounded&&!t&&!e?this.coyoteTime=100:t&&(this.coyoteTime=0),this.isGrounded=t}};var Ct=class{map=new Map;add(t){this.map.set(t.constructor,t)}get(t){return this.map.get(t)}has(t){return this.map.has(t)}delete(t){this.map.delete(t)}},it=class{entities=new Map;systems=new Map;nextEntityId=0;entitiesToDelete=new Array;addEntity(){let t=this.nextEntityId;return this.nextEntityId++,this.entities.set(t,new Ct),t}removeEntity(t){this.entitiesToDelete.push(t)}addComponent(t,e){let i=this.entities.get(t);i&&(i.add(e),this.checkEntitySystemMemberships(t))}getComponents(t){let e=this.entities.get(t);if(!e)throw new Error("Could not find requested entity");return e}removeComponent(t,e){let i=this.entities.get(t);i&&(i.delete(e),this.checkEntitySystemMemberships(t))}addSystem(t){t.ecs=this,this.systems.set(t,new Set);for(let e of this.entities.keys())this.checkEntitySystemMembership(e,t)}querySystem(t){return Array.from(this.systems.entries()).find(([e,i])=>e instanceof t)?.[1]}resolveEntities(t,e){return t?Array.from(t.values()).map(i=>this.getComponents(i)).map(i=>i.get(e)):[]}removeSystem(t){this.systems.delete(t)}update(t){this.systems.entries().forEach(([e,i])=>{e.update(i,t)}),this.entitiesToDelete.forEach(e=>{this.deleteEntity(e)}),this.entitiesToDelete=[]}draw(t){this.systems.entries().forEach(([e,i])=>{e.draw?.(i,t)})}deleteEntity(t){this.entities.delete(t),this.systems.values().forEach(e=>{e.delete(t)})}checkEntitySystemMemberships(t){for(let e of this.systems.keys())this.checkEntitySystemMembership(t,e)}checkEntitySystemMembership(t,e){let i=this.entities.get(t),o=this.systems.get(e);!i||!o||(Array.from(e.componentSet).every(r=>i.has(r))?o.add(t):o.delete(t))}};var M=class{velocity;constructor(t){this.velocity=t}},F=class{componentSet=new Set([c]);ecs;state="pre-lock";update(t){switch(this.state){case"pre-lock":let e=this.ecs.resolveEntities(this.ecs.querySystem(_),f),i=this.ecs.resolveEntities(t,c).filter(o=>o.blocker);if(i.some(o=>e.some(r=>u(o,r))))return;i.forEach(o=>{o.isCollidable=!0}),this.state="locked";return;case"locked":return;case"cleared":return}}},G=class{componentSet=new Set([f]);ecs;update(t,{frameDuration:e}){let i=Array.from(t).map(r=>this.ecs.getComponents(r)),o=this.ecs.resolveEntities(this.ecs.querySystem(F),c);i.forEach(r=>{let n=r.get(f),h=n.isNonPhysical?[]:o;if(r.has(M)){let a=r.get(M).velocity;n.moveX(a.x*e,()=>{},h),n.moveY(a.y*e,()=>{a.y=0},h)}n.isGrounded(o)})}};var ne="a",he="s",ae="d";var Et=28,Nt=36,ce=56,le=72,me=450/1e3,de=2.5/1e3,pe=1,ue=D("./img/sword_man.png"),fe=(s,t,e)=>{let i=0,o=0;return t==="right"&&(i+=Et),s&&(o+=Nt),e&&(i+=Et*2),{x:i,y:o}},O=class{facing;jumpController;constructor(){this.facing="left",this.jumpController=new et}},_=class{componentSet=new Set([O,f,M]);ecs;update(t,{frameDuration:e,keyboardState:i}){t.values().map(o=>this.ecs.getComponents(o)).filter(H).forEach(o=>{let r=o.get(f),n=o.get(M).velocity,h=o.get(O),a=(i[ae]?1:0)-(i[ne]?1:0);n.x=b(a*me,n.x,de*e);let{yAcceleration:m,isJumping:y}=h.jumpController.update(i,e,n.y);n.y+=m*e,y&&(n.y=-pe),a>0?h.facing="right":a<0&&(h.facing="left"),r.setDropping(i[he]),h.jumpController.groundedCheck(r.grounded,y)})}draw(t,e){t.values().map(i=>this.ecs.getComponents(i)).filter(H).forEach(i=>{let o=i.get(f),r=i.get(O),n=!1,{x:h,y:a}=fe(n,r.facing,!0);e.drawImage(ue,h,a,Et,Nt,o.x,o.y,o.width,o.height)})}},kt=(s,t,e)=>{let i=s.addEntity();return s.addComponent(i,new O),s.addComponent(i,new f(t,e,ce,le)),s.addComponent(i,new M({x:0,y:0})),i};var ot=300/1e3,Bt=1/1e3,ye=2/1e3,ge=D("./img/ghosty.png"),Kt=24,xe=32,be=48,we=64,W=class{hp;facing;isNonPhysical;hurtViz;constructor(){this.hp=3,this.facing="left",this.isNonPhysical=!0,this.hurtViz=A(1,250)}},st=class{componentSet=new Set([W,f,M]);ecs;update(t,{frameDuration:e}){let i=this.ecs.resolveEntities(this.ecs.querySystem(_),f).map(r=>P(r));Array.from(t.values().map(r=>this.ecs.getComponents(r))).forEach(r=>{let n=r.get(W),h=P(r.get(f)),a=r.get(M).velocity,[m]=i.reduce(([y,I],L)=>{let E=z(h,L);return E<I?[L,E]:[y,I]},[void 0,1/0]);m&&(m.x<h.x?(a.x=b(-ot,a.x,Bt*e),n.facing="left"):(a.x=b(ot,a.x,Bt*e),n.facing="right"),a.y=b(m.y<h.y?-ot:ot,a.y,ye*e))})}draw(t,e){t.values().forEach(i=>{let o=this.ecs.getComponents(i),r=o.get(W),n=o.get(f);e.drawImage(ge,r.facing==="left"?0:Kt,0,Kt,xe,n.x,n.y,n.width,n.height)})}},Gt=(s,t,e)=>{let i=s.addEntity();s.addComponent(i,new W);let o=new f(t,e,be,we);return o.isNonPhysical=!0,s.addComponent(i,o),s.addComponent(i,new M({x:0,y:0})),i};var U=class{loopDuration;start;midpoint;loopState;constructor(t,e,i){this.loopDuration=t,this.start=e,this.midpoint=i,this.loopState=0}},rt=class{componentSet=new Set([c,U]);ecs;update(t,{frameDuration:e}){let i=this.ecs.resolveEntities(this.ecs.querySystem(G),f).filter(r=>!r.isNonPhysical),o=this.ecs.resolveEntities(this.ecs.querySystem(F),c);t.values().forEach(r=>{let n=this.ecs.getComponents(r),h=n.get(U),a=n.get(c);h.loopState+=e,h.loopState%=h.loopDuration;let m=h.loopState<h.loopDuration/2?h.loopState/h.loopDuration*2:2-h.loopState/h.loopDuration*2,y={x:St(h.start.x,h.midpoint.x,m),y:St(h.start.y,h.midpoint.y,m)};a.move(y.x-(a.x+a.xRemainder),y.y-(a.y+a.yRemainder),i,o)})}};var Y=class{color;rect;constructor(t,e){this.color=e,this.rect=t}},nt=class{componentSet=new Set([Y]);ecs;color;constructor(t){this.color=t}update(){}draw(t,e){t.values().map(o=>this.ecs.getComponents(o)).filter(H).map(o=>o.get(Y)).forEach(({rect:o,color:r})=>{r?e.fillStyle=r:e.fillStyle=this.color,e.fillRect(o.x,o.y,o.width,o.height)})}};var ht=300/1e3,Wt=1/1e3,Ut=2/1e3,Se=D("./img/ghosty.png"),Dt=24,Xt=32,Jt=2,at=class{xVelocity;yVelocity;actor;hp;alive;facing;isNonPhysical;hurtVisualiser;constructor(t,e){this.xVelocity=0,this.yVelocity=0,this.actor=new f(t,e,Dt*Jt,Xt*Jt),this.hp=3,this.alive=!0,this.facing="left",this.isNonPhysical=!0,this.hurtVisualiser=A(1,250)}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(1000%) saturate(0%)"),t.drawImage(Se,this.facing==="left"?0:Dt,0,Dt,Xt,this.actor.x,this.actor.y,this.actor.width,this.actor.height),t.filter="none",!1}update(t,e,i){this.updateVelocities(t,e,i),this.isNonPhysical?(this.actor.moveX(this.xVelocity*t,()=>{},[]),this.actor.moveY(this.yVelocity*t,()=>{},[])):(this.actor.moveX(this.xVelocity*t,()=>{this.xVelocity=0},e.solids),this.actor.moveY(this.yVelocity*t,()=>{this.yVelocity=0},e.solids)),this.hurtVisualiser.down(t)}updateVelocities(t,e,i){let o=this.actor.getMidpoint();i?(i.x<o.x?(this.xVelocity=b(-ht,this.xVelocity,Wt*t),this.facing="left"):(this.xVelocity=b(ht,this.xVelocity,Wt*t),this.facing="right"),i.y<o.y?this.yVelocity=b(-ht,this.yVelocity,Ut*t):this.yVelocity=b(ht,this.yVelocity,Ut*t)):this.facing=this.xVelocity<0?"left":"right"}applyDamage(t,e){this.hp-=1,this.xVelocity+=e?.x??0,this.yVelocity+=e?.y??0,this.hp<=0&&(this.alive=!1),this.hurtVisualiser.up()}intersects(t){if(u(t,this.actor))return this.actor}};var zt=180/1e3,j=2/1e3,Re=2.5/1e3,$=class extends at{constructor(t,e){super(t,e),this.hp=5,this.isNonPhysical=!1,this.facing="left"}updateVelocities(t,e,i){this.yVelocity+=Re*t;let o={x:this.actor.x,y:this.actor.y+this.actor.height,width:this.actor.width,height:1};e.solids.some(r=>r.isCollidable&&u(r,o))||(this.xVelocity=b(0,this.xVelocity,j/2)),this.facing==="left"?this.canMoveLeft(e)?this.xVelocity=b(-zt,this.xVelocity,j):this.canMoveRight(e)&&(this.facing="right",this.xVelocity=b(0,this.xVelocity,j)):this.canMoveRight(e)?this.xVelocity=b(zt,this.xVelocity,j):this.canMoveLeft(e)&&(this.facing="left",this.xVelocity=b(0,this.xVelocity,j))}canMoveLeft(t){let e={x:this.actor.x-this.actor.width/2,y:this.actor.y+this.actor.height,width:this.actor.width/4,height:1},i={x:this.actor.x-this.actor.width,y:this.actor.y,height:this.actor.height,width:this.actor.width};return t.solids.some(o=>o.isCollidable&&!o.isDroppable&&u(o,e))&&t.solids.every(o=>!o.isCollidable||!u(o,i))}canMoveRight(t){let e={x:this.actor.x+this.actor.width/4*5,y:this.actor.y+this.actor.height,width:this.actor.width/4,height:1},i={x:this.actor.x+this.actor.width,y:this.actor.y,height:this.actor.height,width:this.actor.width};return t.solids.some(o=>o.isCollidable&&!o.isDroppable&&u(o,e))&&t.solids.every(o=>!o.isCollidable||o.isDroppable||!u(o,i))}applyDamage(t,e){super.applyDamage(t,e),this.yVelocity-=.3}};var T=(s,t)=>{let e=s.x??s.left,i=s.y??s.top,o=s.width??s.right-e,r=s.height??s.bottom-i;if(isNaN(e)||isNaN(i)||isNaN(o)||isNaN(r))throw new Error("Invalid parameters to create solid!");return new c(e,i,o,r,t)},C=(s={})=>{let t=Object.keys(s).filter(e=>s[e]);return t.sort((e,i)=>w[e][0]-w[i][0]),t};var v=s=>{let t=[],e=[],i=d/2-N/2,o=i+N,r=[0].concat(C(s.top).map(l=>w[l][1])),n=C(s.top).map(l=>w[l][0]).concat(d);t.push(...r.map((l,x)=>T({left:l,right:n[x],y:0,height:g}))),e.push(...C(s.top).map(l=>w[l]).map(([l,x])=>T({left:l,right:x,y:0,height:g})));let h=[0].concat(C(s.bottom).map(l=>w[l][1])),a=C(s.bottom).map(l=>w[l][0]).concat(d);t.push(...h.map((l,x)=>T({left:l,right:a[x],y:p-g,height:g}))),t.push(...C(s.bottom).map(l=>T({left:w[l][0],right:w[l][1],top:p-g,height:g/4},{isDroppable:!0}))),e.push(...C(s.bottom).map(l=>w[l]).map(([l,x])=>T({left:l,right:x,y:p-g,height:g})));let m=[0].concat(C(s.left).map(l=>w[l][1])),y=C(s.left).map(l=>w[l][0]).concat(p);t.push(...m.map((l,x)=>T({top:l,bottom:y[x],left:0,width:g}))),e.push(...C(s.left).map(l=>w[l]).map(([l,x])=>T({top:l,bottom:x,x:0,width:g})));let I=[0].concat(C(s.right).map(l=>w[l][1])),L=C(s.right).map(l=>w[l][0]).concat(p);t.push(...I.map((l,x)=>T({top:l,bottom:L[x],left:d-g,width:g}))),e.push(...C(s.right).map(l=>w[l]).map(([l,x])=>T({top:l,bottom:x,x:d-g,width:g})));let E=[];return E.push(T({left:i-N,width:N,top:420,height:g/4},{isDroppable:!0})),E.push(T({left:i-N,width:N,top:570,height:g/4},{isDroppable:!0})),E.push(T({left:i,right:o,top:140,height:g/4},{isDroppable:!0})),{blockers:e.map(l=>(l.blocker=!0,l.color="brown",l.isCollidable=!1,l)),solids:t,ladders:E}};var g=40,d=1280,p=720,N=g*6,w={high:[120,240],medium:[p/2-40,p/2+80],low:[p-160,p-40],left:[80,280],center:[d/2-100,d/2+100],right:[d-280,d-80]},qt=["left","center","right"],jt=["high","medium","low"],S=class{getDoorwayChance(){return .5}static getDoorArrangement(){return{top:{},bottom:{},left:{},right:{}}}static isValidAt(t,e){return!0}static areDoorsOk(t){let e=this.getDoorArrangement();return jt.every(i=>(e.left[i]===void 0||t.left[i]===void 0||e.left[i]===t.left[i])&&(e.right[i]===void 0||t.right[i]===void 0||e.right[i]===t.right[i]))&&qt.every(i=>(e.top[i]===void 0||t.top[i]===void 0||e.top[i]===t.top[i])&&(e.bottom[i]===void 0||t.bottom[i]===void 0||e.bottom[i]===t.bottom[i]))}x;y;width;height;color;blockersLocked;allEnemiesCleared;doors;ecs;constructor(t,e,i,o,r="blue",n={}){this.x=t,this.y=e,this.width=i,this.height=o,this.ecs=new it,this.ecs.addSystem(new G),this.ecs.addSystem(new F),this.ecs.addSystem(new nt(r)),this.ecs.addSystem(new _),this.ecs.addSystem(new rt),this.ecs.addSystem(new st),this.color=r,this.blockersLocked=!1,this.allEnemiesCleared=!1,this.doors={left:n.left??{},right:n.right??{},top:n.top??{},bottom:n.bottom??{}},this.globalDoorwayRectification(),this.configureAllDoors(),this.configureRoomContent(),kt(this.ecs,.5*d,.08*p)}globalDoorwayRectification(){this.x===0&&this.y===0?this.doors={bottom:{center:!0,left:!1,right:!1},top:{center:!1,left:!1,right:!1},left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1}}:this.x===0&&this.y===1?this.doors.top={center:!0,left:!1,right:!1}:this.y===1&&(this.doors.top={center:!1,left:!1,right:!1})}configureAllDoors(){let t=this.constructor.getDoorArrangement(),e=this.getDoorwayChance();jt.forEach(i=>{this.doors.left[i]===void 0&&(this.doors.left[i]=t.left[i]??Math.random()<e),this.doors.right[i]===void 0&&(this.doors.right[i]=t.right[i]??Math.random()<e)}),qt.forEach(i=>{this.doors.top[i]===void 0&&(this.doors.top[i]=t.top[i]??Math.random()<e),this.doors.bottom[i]===void 0&&(this.doors.bottom[i]=t.bottom[i]??Math.random()<e)})}configureRoomContent(){let{solids:t,blockers:e,ladders:i}=v(this.doors);t.concat(e).concat(i).forEach(n=>{let h=this.ecs.addEntity();this.ecs.addComponent(h,n),this.ecs.addComponent(h,new Y(n,n.color))});let o=this.ecs.addEntity(),r=new c(300,280,200,40);this.ecs.addComponent(o,r),this.ecs.addComponent(o,new Y(r,this.color)),this.ecs.addComponent(o,new U(7e3,{x:300,y:280},{x:600,y:280})),Gt(this.ecs,d,p)}draw(t,e,i,o){t.fillStyle="black",t.fillRect(0,0,e.width,e.height),this.ecs.draw(t)}update(t,e,i,o){this.ecs.update({mousePosition:t,keyboardState:e,frameDuration:i})}validateLeavingRoom(t){}onAllEnemiesCleared(){}setExternalMatchingDoorways(t){let e={};for(let i in t){let o=i;for(let r in t[o]){let n=r;if(o==="left"||o==="right"){let h=r;t[o][h]===!1&&this.doors[o][h]===!0&&(e[o]=e[o]??{},e[o][h]=!0)}else{let h=r;t[o][h]===!1&&this.doors[o][h]===!0&&(e[o]=e[o]??{},e[o][h]=!0)}}}}drawForMap(t){t.fillStyle=this.color}addParticle(t){}};var X=class{x;y;width;height;color;xVelocity;yVelocity;lifeLeft;lifespan;alive;affectedByGravity;constructor(t,e,i,o,r,n,h,a,m=!1){this.x=t,this.y=e,this.width=i,this.height=o,this.color=r,this.xVelocity=n,this.yVelocity=h,this.lifeLeft=a,this.lifespan=a,this.alive=!0,this.affectedByGravity=m}draw(t){t.filter=`opacity(${Math.round(100*this.lifeLeft/this.lifespan)}%)`,t.fillStyle=this.color,t.fillRect(Math.round(this.x),Math.round(this.y),this.width,this.height),t.filter="none"}update(t){this.affectedByGravity&&(this.yVelocity+=t*.0025),this.x+=t*this.xVelocity,this.y+=t*this.yVelocity,this.lifeLeft=Math.max(0,this.lifeLeft-t),this.lifeLeft<=0&&(this.alive=!1)}};var Ce=200,k=120,$t=500/1e3,Mt=D("./img/theghost.png"),Ee={x:100,y:100,width:d-200,height:p-200},Zt={x:-100,y:-100,width:d+200,height:p+200},ct=class{hp;alive;isNonPhysical;facing;x;y;xVelocity=0;yVelocity=0;collider;hurtVisualiser;particleCooldown;strategy;isStrategyComplete;distFromStart;distFromTarget;constructor(t,e){this.hp=20,this.alive=!0,this.isNonPhysical=!1,this.facing="left",this.x=t,this.y=e,this.collider={x:this.x-k/2,y:this.y-k/2,width:k,height:k},this.hurtVisualiser=A(1,250),this.particleCooldown=A(1,40),this.strategy="initialWait",this.isStrategyComplete=!1,this.distFromStart=()=>0,this.distFromTarget=()=>0}update(t,e,i){switch(this.hurtVisualiser.down(t),this.particleCooldown.down(t),this.strategy){case"initialWait":tt(Ee,i.x,i.y)&&this.initFlee(i);return;case"flee":let o=.8+Math.min(1.2,this.distFromStart()/600);this.collider.x+=this.xVelocity*t*o,this.collider.y+=this.yVelocity*t*o,u(Zt,this.collider)||this.initCharge(i),this.addParticle(e);return;case"charge":let r=.8+Math.min(1.2,this.distFromTarget()/600);this.collider.x+=this.xVelocity*t*r,this.collider.y+=this.yVelocity*t*r,this.distFromTarget()<=10&&this.initFlee(i),this.addParticle(e);return}}addParticle(t){if(this.particleCooldown.check()<=0){let e=Yt(this.collider),i=4;t.addParticle(new X(e.x-i/2,e.y-i/2,4,4,"white",this.xVelocity*.3,this.yVelocity*.3,360,!1)),this.particleCooldown.up(1)}}initFlee(t){this.strategy="flee";let e=P(this.collider),i={x:t.x-e.x,y:t.y-e.y},o=Rt(i,$t);this.xVelocity=o.x,this.yVelocity=o.y,this.distFromStart=()=>z(P(this.collider),e)}initCharge(t){this.strategy="charge";let e=Ft(Zt);this.collider.x=e.x-k/2,this.collider.y=e.y-k/2;let i=t.x,o=t.y,r={x:i-e.x,y:o-e.y},n=Rt(r,$t);this.xVelocity=n.x,this.yVelocity=n.y,this.distFromTarget=()=>{let h=P(this.collider);return z(h,{x:i,y:o})}}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(10000%) saturate(0%)");let e=Math.round(this.collider.x),i=Math.round(this.collider.y),o=(Ce-k)/2;t.drawImage(Mt,0,0,Mt.width,Mt.height,e-o,i-o,this.collider.width+2*o,this.collider.height+2*o),t.filter="none",!1}applyDamage(t){this.hp-=1,this.hurtVisualiser.up(1),this.hp<0&&(this.alive=!1)}intersects(t){if(u(t,this.collider))return this.collider}};var lt=class extends S{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!0,medium:!1,low:!1},right:{high:!0,medium:!1,low:!1},bottom:{left:!1,center:!1,right:!1},top:{left:!1,center:!1,right:!1}}}static isValidAt(){return!0}configureRoomContent(){let{solids:t,blockers:e}=v(this.doors);this.solids=t.concat(e).concat(...[240,390,540].map(i=>new c(40,i,d-80,10,{isDroppable:!0}))),this.enemies=[new ct(d/2,p/2)]}};var mt=class extends S{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1},bottom:{left:!0,center:!1,right:!0},top:{left:!0,center:!1,right:!0}}}static isValidAt(t,e){return e>=2}configureRoomContent(){let{blockers:t}=v(this.doors);this.solids=t.concat(new c(0,0,80,p),new c(d-80,0,80,p),new c(280,0,720,260),new c(280,460,720,260),new c(80,p-40,200,10,{isDroppable:!0}),new c(120,570,120,10,{isDroppable:!0}),new c(80,460,200,10,{isDroppable:!0}),new c(80,120,200,10,{isDroppable:!0}),new c(80,250,200,10,{isDroppable:!0}),new c(80,355,100,10,{isDroppable:!0}),new c(1e3,p-40,200,10,{isDroppable:!0}),new c(1040,570,120,10,{isDroppable:!0}),new c(1e3,460,200,10,{isDroppable:!0}),new c(1e3,120,200,10,{isDroppable:!0}),new c(1e3,250,200,10,{isDroppable:!0}),new c(1100,355,100,10,{isDroppable:!0}))}};var dt=class extends S{getDoorwayChance(){return .1}static getDoorArrangement(){return{left:{},right:{high:!1,medium:!1,low:!0},bottom:{},top:{left:!0,center:!1,right:!1}}}static isValidAt(t,e){return e>=2}configureRoomContent(){let{solids:t,blockers:e}=v(this.doors);this.solids=t.concat(e).concat(new c(380,0,d-380,450),new c(120,140,120,10,{isDroppable:!0}),new c(40,240,340,10,{isDroppable:!0}),new c(this.doors?.left?.center?160:40,340,this.doors.left.center?220:340,10,{isDroppable:!0}),new c(40,440,340,10,{isDroppable:!0}),new c(40,this.doors.left.low?550:540,240,10,{isDroppable:!0}))}};var Qt=340,Tt=76,te=60,ee=80,pt=2.5/1e3,vt=D("./img/spitboss-head.png"),Vt=D("./img/spitboss-base.png"),It=D("./img/spitboss-spit.png"),ut=class{hp;alive;isNonPhysical;x;y;baseBox;headBox;hurtVisualiser;fireCooldown;constructor(t,e){this.hp=50,this.alive=!0,this.isNonPhysical=!1,this.x=t,this.y=e,this.baseBox={x:this.x-Qt/2,y:this.y-Tt,width:Qt,height:Tt},this.headBox={x:this.x-te/2,y:Math.round(this.y-ee-.75*Tt),width:te,height:ee},this.hurtVisualiser=A(1,250),this.fireCooldown=A(1,1200)}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(1000%) saturate(0%)");let e=8,i=8;t.drawImage(Vt,0,0,Vt.width,Vt.height,this.baseBox.x-e,this.baseBox.y-i,this.baseBox.width+2*e,this.baseBox.height+i);let o=4;t.drawImage(vt,0,0,vt.width,vt.height,this.headBox.x-o,this.headBox.y-o,this.headBox.width+2*o,this.headBox.height+2*o),t.filter="none",!1}update(t,e,i){if(this.hurtVisualiser.down(t),this.fireCooldown.down(t),this.fireCooldown.check()===0){let o=this.createProjectile(e,i);o&&o.length>0&&(this.fireCooldown.up(1),e.enemies.push(...o))}}createProjectile(t,e){let i={x:this.x-5,width:10,y:0,height:this.y},r=t.solids.filter(l=>l.isCollidable&&!l.isDroppable&&u(l,i)).reduce((l,x)=>Math.max(l,x.y+x.height),0),n=this.y-100,h=n-r-Z,a=-Math.sqrt(2*pt*h);if(e.y<=h)return;let m=R(.8,1)*a,y=m*m-2*pt*(n-e.y);if(y<=0)return;let I=(-m+Math.sqrt(y))/pt,L=(e.x-this.x)/I,E=K(1,4);return new Array(E).fill(0).map(()=>new At(this.x,n,L+R(-.1,.1),m+R(-.01,.1),this))}applyDamage(t){t===this.headBox?(this.hp-=3,this.hurtVisualiser.up(1)):t===this.baseBox&&(this.hp-=.2,this.hurtVisualiser.up(.2)),this.hp<0&&(this.alive=!1)}intersects(t){if(u(t,this.headBox))return this.headBox;if(u(t,this.baseBox))return this.baseBox}},Z=14,At=class{actor;xVelocity;yVelocity;parent;alive;struck;hitVisualiser;constructor(t,e,i,o,r){this.actor=new f(t-Z,e-Z,Z*2,Z*2),this.xVelocity=i,this.yVelocity=o,this.parent=r,this.alive=!0,this.struck=!1,this.hitVisualiser=A(1,150)}draw(t){t.drawImage(It,0,0,It.width,It.height,this.actor.x-2,this.actor.y-2,this.actor.width+4,this.actor.height+4)}addParticle(t,e,i){t.addParticle(new X(e.x-3,e.y-3,6,6,Math.random()>.5?"#674cd3":"#9e5eff",i.x,i.y,R(120,200),!0))}update(t,e,i){this.hitVisualiser.down(t);let o=r=>n=>{this.alive=!1;let h=r==="x"?{x:this.xVelocity>0?n.x:n.x+n.width,y:this.actor.y+this.actor.height/2}:{x:this.actor.x+this.actor.width/2,y:this.yVelocity>0?n.y:n.y+n.height};for(let a=0;a<12;a++){let m=r==="x"?{x:-this.xVelocity*R(.4,.6),y:R(-.2,.2)}:{x:R(-.2,.2),y:-this.yVelocity*R(.2,.3)};this.addParticle(e,h,m)}};if(this.yVelocity+=pt*t,this.actor.moveX(this.xVelocity*t,o("x"),e.solids),this.actor.moveY(this.yVelocity*t,o("y"),e.solids),this.struck&&this.parent.alive){let r=this.parent.intersects(this.actor);if(r){this.parent.applyDamage(r);let n=Lt(P(this.actor),Ht(r,16));for(let h=0;h<12;h++){let a={x:-this.xVelocity*R(.4,.6)+R(-.2,.2),y:-this.yVelocity*R(.2,.3)+R(-.2,.2)};this.addParticle(e,n,a)}this.alive=!1}}}applyDamage(t,e){this.hitVisualiser.up(1),this.xVelocity=e?.x??0,this.yVelocity=e?.y??0,this.struck=!0}intersects(t){if(u(t,this.actor))return this.actor}};var ft=class extends S{getDoorwayChance(){return .1}static getDoorArrangement(){return{left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1},bottom:{left:!1,center:!1,right:!1},top:{left:!1,center:!0,right:!1}}}static isValidAt(t,e){return!0}configureRoomContent(){let{solids:t,blockers:e}=v(this.doors);this.solids=t.concat(e).concat(new c(320,160,920,40),new c(840,0,440,200),new c(0,0,80,p),new c(d-80,0,80,p),new c(0,p-80,d,80),new c(80,160,240,10,{isDroppable:!0})),this.enemies=[new ut(780,p-80)]}onAllEnemiesCleared(){super.onAllEnemiesCleared(),this.solids=this.solids.concat(...[320,480].map(t=>new c(80,t,240,10,{isDroppable:!0})))}};var yt=class extends S{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!0,medium:!1,low:!1},right:{high:!0,medium:!1,low:!1},bottom:{left:!1,center:!0,right:!1},top:{}}}configureRoomContent(){let{solids:t,blockers:e}=v(this.doors);this.solids=t.concat(e).concat(new c(0,240,440,p-240),new c(840,240,d-840,p-240),new c(440,240,400,10,{isDroppable:!0}),new c(440,380,400,10,{isDroppable:!0}),new c(440,520,400,10,{isDroppable:!0})).concat(...[this.doors.top.left?new c(120,120,120,10,{isDroppable:!0}):void 0,this.doors.top.center?new c(580,120,120,10,{isDroppable:!0}):void 0,this.doors.top.right?new c(1040,120,120,10,{isDroppable:!0}):void 0].filter(H)),this.enemies=[new $(d/4,176),new $(d*3/4,176)]}};var B=128,J=72,ie=9,oe=6,se=1/10,Q=2,re=4,gt=class{lastRoomIndex;map;x;y;currentIndex;minX;minY;canvas;ctx;constructor(){this.lastRoomIndex={x:0,y:0},this.map={},this.x=0,this.y=0,this.currentIndex=this.index(0,0),this.minX=0,this.minY=0;let t=new S(0,0,1,1);this.map[this.index(0,0)]=t;let e=Math.max(ie),i=Math.max(oe);this.canvas=new OffscreenCanvas(e*B,i*J);let o=this.canvas.getContext("2d");if(!o)throw Error("Could not construct canvas");this.ctx=o,this.redrawWorldMap()}createNewCanvas(t,e,i,o){let r=Math.max(ie,e-t+1+re),n=Math.max(oe,o-i+1+re);this.canvas=new OffscreenCanvas(r*B,n*J);let h=this.canvas.getContext("2d");if(!h)throw Error("Could not construct canvas");this.ctx=h}getNeighboringDoors(t,e){return{right:{...this.map[this.index(t+1,e)]?.doors?.left},left:{...this.map[this.index(t-1,e)]?.doors?.right},top:{...this.map[this.index(t,e-1)]?.doors?.bottom},bottom:{...this.map[this.index(t,e+1)]?.doors?.top}}}generateRoomChoices(t,e,i={}){let o=()=>`hsl(${K(0,360)}, 60%, 60%)`,r=()=>({left:{...i.left??{}},right:{...i.right??{}},top:{...i.top??{}},bottom:{...i.bottom??{}}}),n=[lt,mt,dt,yt,ft],h=r(),a=n.filter(y=>y.isValidAt(t,e)&&y.areDoorsOk(h));a.push(S,S,S);let m=[];for(let y=0;y<3;y++){let I=a.shift();if(!I)throw new Error("Could not find enough rooms");m.push(new I(t,e,1,1,o(),r()))}return m}redrawWorldMap(){let t=0,e=0;for(let i of Object.values(this.map))this.minX=Math.min(this.minX,i.x),t=Math.max(t,i.x),this.minY=Math.min(this.minY,i.y),e=Math.max(e,i.y);(t-this.minX+1>this.canvas.width/B||e-this.minY+1>this.canvas.height/J)&&this.createNewCanvas(this.minX,t,this.minY,e),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let i of Object.values(this.map))this.ctx.save(),this.ctx.translate((i.x-this.minX)*B,(i.y-this.minY)*J),this.ctx.scale(se,se),i.drawForMap(this.ctx),this.ctx.restore()}drawMapToScreen(t,e,i,o,r){let n=Math.min(o,this.canvas.width),h=Math.min(r,this.canvas.height),a=(-this.minX+this.x+1/2)*B-o/2;t.drawImage(this.canvas,a,0,n,h,e,i,n,h),t.strokeStyle="white",t.lineWidth=Q,t.strokeRect(-a+(this.x-this.minX+1/2)*B-Q,i+this.y*J-Q,B+Q*2,J+Q*2)}index(t,e){return`${t},${e}`}getCurrentRoom(){return this.map[this.currentIndex]}getPreviousRoom(){return this.map[this.index(this.lastRoomIndex.x,this.lastRoomIndex.y)]}hasRoom(t,e){return this.index(t,e)in this.map}enterRoom(t,e){this.lastRoomIndex={x:this.x,y:this.y},this.x=t,this.y=e,this.currentIndex=this.index(t,e),this.redrawWorldMap()}addRoom(t){if(this.map[this.currentIndex])throw new Error("Adding room where we already have one!");this.map[this.currentIndex]=t,this.map[this.index(this.x-1,this.y)]?.setExternalMatchingDoorways?.({right:t.doors.left}),this.map[this.index(this.x+1,this.y)]?.setExternalMatchingDoorways?.({left:t.doors.right}),this.map[this.index(this.x,this.y-1)]?.setExternalMatchingDoorways?.({bottom:t.doors.top}),this.map[this.index(this.x,this.y+1)]?.setExternalMatchingDoorways?.({top:t.doors.bottom}),t.setExternalMatchingDoorways({left:this.map[this.index(this.x-1,this.y)]?.doors?.right,right:this.map[this.index(this.x+1,this.y)]?.doors?.left,top:this.map[this.index(this.x,this.y-1)]?.doors?.bottom,bottom:this.map[this.index(this.x,this.y+1)]?.doors?.top}),this.redrawWorldMap()}};var xt=10,De="Tab",V=64,bt=4,wt=class{worldMap;lastFrameTime;unprocessedTime;pausedFor;choosing;choices;tabLatch;mouseOverChoiceIndex;firstTickInNewRoom;constructor(){this.worldMap=new gt,this.lastFrameTime=performance.now(),this.unprocessedTime=0,this.pausedFor=void 0,this.choosing=!0,this.choices=[],this.tabLatch=_t(!1),this.mouseOverChoiceIndex=-1,this.firstTickInNewRoom=!1}update(t,e,i,o){if(this.tabLatch(!!o[De],{onLock:()=>{this.pausedFor==="Tab"?(this.lastFrameTime=performance.now(),this.pausedFor=void 0):this.pausedFor||(this.pausedFor="Tab")}}),this.pausedFor==="choices"){this.choices.length===0&&(this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y)),this.draw(t,e,i,0),this.drawMap(t,e),this.drawOptions(t,e,i);return}else if(this.pausedFor==="Tab"){this.draw(t,e,i,0),this.drawMap(t,e);return}let r=performance.now(),n=this.firstTickInNewRoom?0:Math.min(r-this.lastFrameTime,250);for(this.lastFrameTime=r,this.firstTickInNewRoom=!1,this.unprocessedTime+=n;this.unprocessedTime>=xt&&!this.pausedFor;)this.simulateFrame(i,o),this.unprocessedTime-=xt;this.pausedFor&&(this.unprocessedTime=0);let h=this.unprocessedTime/xt;this.draw(t,e,i,h)}drawMap(t,e){t.fillStyle="#00000099",t.fillRect(0,0,e.width,e.height),t.fillStyle="white",t.fillRect(V-bt,V-bt,e.height-(V-bt)*2,e.height-(V-bt)*2),t.fillStyle="black",t.fillRect(V,V,e.height-V*2,e.height-V*2),this.worldMap.drawMapToScreen(t,V,V,e.height-V*2,e.height-V*2)}click(t,e){let i=this.pausedFor==="choices"&&this.choices.length>0,o=this.mouseOverChoiceIndex>=0&&this.mouseOverChoiceIndex<this.choices.length;if(i&&o){let r=this.choices[this.mouseOverChoiceIndex];this.worldMap.addRoom(r);let n=this.worldMap.getPreviousRoom();this.transferPlayerPosition(n,r),this.unprocessedTime=0,this.firstTickInNewRoom=!0,this.pausedFor=void 0,this.choices=[]}}transferPlayerPosition(t,e){let i=t.ecs.querySystem(_),o=e.ecs.querySystem(_);if(i?.size!==1||o?.size!==1)return;let r=t.ecs.getComponents(Array.from(i.values())[0]),n=e.ecs.getComponents(Array.from(o.values())[0]);if(!r||!n)return;let h=r.get(O),a=n.get(O)}simulateFrame(t,e){this.worldMap.getCurrentRoom().update(t,e,xt,this.onRoomChange.bind(this))}onRoomChange(t,e,i){this.worldMap.hasRoom(t,e)?(this.worldMap.enterRoom(t,e),this.transferPlayerPosition(this.worldMap.getPreviousRoom(),this.worldMap.getCurrentRoom())):(this.pausedFor="choices",this.worldMap.enterRoom(t,e),this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y,i))}draw(t,e,i,o){let r=this.worldMap.getCurrentRoom();r&&r.draw(t,e,i,o)}drawOptions(t,e,i){this.mouseOverChoiceIndex=-1;for(let o=0;o<this.choices.length;o++){let r=this.choices[o],n=e.height,h=e.width,a=(n+h)/2,m=e.height/this.choices.length,y=m*o,I=y+m;t.save(),t.translate(a,(y+I)/2);let L=i&&tt({x:n,y,width:h-n,height:m},i.x,i.y),E=(h-n)/d*.5;t.scale(E,E),L&&(this.mouseOverChoiceIndex=o,t.scale(1.1,1.1)),t.translate(-d/2,-p/2),r.drawForMap(t),t.restore()}}};function Me(){let s=document.getElementById("canvas");if(!s){console.error("Could not find canvas");return}let t=s.getContext("2d");if(!t)throw Error("Could not set up canvas rendering context");t.imageSmoothingEnabled=!1;let e=new wt,i;s.addEventListener("mousemove",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,m=n.clientY-h.top;i={x:a,y:m}}),s.addEventListener("mouseleave",()=>{i=void 0}),s.addEventListener("click",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,m=n.clientY-h.top;i={x:a,y:m},e.click(s,i)});let o={};window.addEventListener("keydown",n=>{o[n.key]=!0,(n.key==="Tab"||n.key===" ")&&n.preventDefault()}),window.addEventListener("keyup",n=>{delete o[n.key]}),window.addEventListener("blur",()=>{o={}});function r(){e.update(t,s,i,o),requestAnimationFrame(r)}r()}document.addEventListener("DOMContentLoaded",()=>{Me()});})();
//# sourceMappingURL=index.js.map
