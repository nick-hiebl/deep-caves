"use strict";(()=>{var Lt=s=>{let t=s;return(e,{onLock:o,onRelease:i})=>{e!==t&&(t=e,e?o&&o():i&&i())}},I=(s,t)=>{let e=0;return{up(o=1){e=Math.min(1,e+o/s)},down(o=1){e=Math.max(0,e-o/t)},check(){return e}}};function Et(s,t,e){return(1-e)*s+e*t}function K(s,t){return Math.floor((t-s)*Math.random())}function g(s,t){return s+Math.random()*(t-s)}function u(s,t){return!(s.x>=t.x+t.width||t.x>=s.x+s.width||s.y>=t.y+t.height||t.y>=s.y+s.height)}function ot(s,t,e){return s.x<=t&&t<s.x+s.width&&s.y<=e&&e<s.y+s.height}function et(s){return s*s}function w(s,t,e){return s>t?Math.min(s,t+e):s<t?Math.max(s,t-e):s}function Ht(s,t,e){return Math.max(t,Math.min(s,e))}function Ft(s,t){return{x:Ht(s.x,t.x,t.x+t.width),y:Ht(s.y,t.y,t.y+t.height)}}function Yt(s,t){return{x:s.x+t,y:s.y+t,width:s.width-2*t,height:s.height-2*t}}function L(s){return{x:s.x+s.width/2,y:s.y+s.height/2}}function Dt(s,t){let e=Math.sqrt(s.x*s.x+s.y*s.y);return{x:s.x*t/e,y:s.y*t/e}}function z(s,t){return Math.sqrt(et(s.x-t.x)+et(s.y-t.y))}function Nt(s){let t=s.width+s.height,e=g(0,t);return e<s.width?{x:s.x+e,y:K(0,2)?s.y:s.y+s.height}:{x:K(0,2)?s.x:s.x+s.width,y:s.y+(e-s.width)}}function Bt(s){return{x:s.x+g(0,s.width),y:s.y+g(0,s.height)}}var c=class{x;y;height;width;isCollidable;isDroppable;color;xRemainder;yRemainder;blocker;constructor(t,e,o,i,r={}){this.x=t,this.y=e,this.width=o,this.height=i,this.isCollidable=!0,this.isDroppable=r.isDroppable??!1,this.blocker=!1,this.xRemainder=0,this.yRemainder=0}move(t,e,o,i){this.xRemainder+=t,this.yRemainder+=e;let r=Math.round(this.xRemainder),n=Math.round(this.yRemainder);if(r!==0||n!==0){let h=o.filter(a=>a.isRiding(this));if(this.isCollidable=!1,r!==0){if(this.xRemainder-=r,this.x+=r,r>0)for(let a of o)u(this,a)?a.moveX(this.x+this.width-a.x,a.squish,i):h.some(m=>m===a)&&a.moveX(r,()=>{},i);else if(r<0)for(let a of o)u(this,a)?a.moveX(this.x-(a.x+a.width),a.squish,i):h.some(m=>m===a)&&a.moveX(r,()=>{},i)}this.isCollidable=!0}}};var f=class{x;y;width;height;xRemainder;yRemainder;isDropping;droppingSet;grounded;isNonPhysical;constructor(t,e,o,i){this.x=t,this.y=e,this.width=o,this.height=i,this.xRemainder=0,this.yRemainder=0,this.isDropping=!1,this.droppingSet=new Set,this.grounded=!1,this.isNonPhysical=!1}setDropping(t){this.isDropping=!!t,this.droppingSet=new Set(Array.from(this.droppingSet).filter(e=>u(this,e)))}moveX(t,e,o){this.xRemainder+=t;let i=Math.round(this.xRemainder);if(i!==0){this.xRemainder-=i;let r=i>0?1:-1;for(;i!==0;){this.x+=r,i-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(o);if(h.forEach(a=>{this.droppingSet.add(a)}),n){this.x-=r,e(n);break}}}}moveY(t,e,o){this.yRemainder+=t;let i=Math.round(this.yRemainder);if(i!==0){this.yRemainder-=i;let r=i>0?1:-1;for(;i!==0;){this.y+=r,i-=r;let{collidingSolid:n,droppingThroughSolids:h}=this.collideAt(o);if((r<0||this.isDropping)&&h.length>0?h.forEach(a=>this.droppingSet.add(a)):h.length>0&&(n=h[0]),n){this.y-=r,e(n);break}}}}isGrounded(t){let e={x:this.x,y:this.y+this.height,width:this.width,height:1},o=t.find(i=>this.droppingSet.has(i)||this.isDropping&&i.isDroppable?!1:u(e,i));return this.grounded=!!o,this.grounded}collideAt(t){let e=[];return{collidingSolid:t.find(i=>!i.isCollidable||!u(this,i)?!1:i.isDroppable?(this.droppingSet.has(i)||e.push(i),!1):!0),droppingThroughSolids:e}}isRiding(t){return u(t,{x:this.x,y:this.y+this.height,width:this.width,height:1})}squish(){console.log("Squish")}getMidpoint(){return{x:this.x+this.width/2,y:this.y+this.height/2}}};var v=s=>{let t=new Image;return t.src=s,t};function F(s){return s!=null}var it=class{isGrounded;coyoteTime;timeSinceJumpPress;isJumpKeyDown;stillHoldingJump;constructor(){this.isGrounded=!1,this.coyoteTime=0,this.timeSinceJumpPress=200,this.isJumpKeyDown=!1,this.stillHoldingJump=!1}update(t,e,o){this.coyoteTime-=e,t[" "]?this.isJumpKeyDown?this.timeSinceJumpPress+=e:(this.isJumpKeyDown=!0,this.timeSinceJumpPress=0):(this.stillHoldingJump=!1,this.isJumpKeyDown=!1,this.timeSinceJumpPress=200);let r=this.isJumpKeyDown&&this.timeSinceJumpPress<100&&(this.isGrounded||this.coyoteTime>0);return r&&(this.stillHoldingJump=!0,this.timeSinceJumpPress=200,this.coyoteTime=0),{isJumping:r,yAcceleration:this.getGravity(o)}}getGravity(t){return t>-.5||!this.stillHoldingJump?.006:.0025}groundedCheck(t,e){this.isGrounded&&!t&&!e?this.coyoteTime=100:t&&(this.coyoteTime=0),this.isGrounded=t}};var Mt=class{map=new Map;add(t){this.map.set(t.constructor,t)}get(t){return this.map.get(t)}has(t){return this.map.has(t)}delete(t){this.map.delete(t)}},st=class{entities=new Map;systems=new Map;nextEntityId=0;entitiesToDelete=new Array;addEntity(){let t=this.nextEntityId;return this.nextEntityId++,this.entities.set(t,new Mt),t}removeEntity(t){this.entitiesToDelete.push(t)}addComponent(t,e){let o=this.entities.get(t);o&&(o.add(e),this.checkEntitySystemMemberships(t))}getComponents(t){let e=this.entities.get(t);if(!e)throw new Error("Could not find requested entity");return e}removeComponent(t,e){let o=this.entities.get(t);o&&(o.delete(e),this.checkEntitySystemMemberships(t))}addSystem(t){t.ecs=this,this.systems.set(t,new Set);for(let e of this.entities.keys())this.checkEntitySystemMembership(e,t)}querySystem(t){return Array.from(this.systems.entries()).find(([e])=>e instanceof t)?.[1]}resolveEntities(t,e){return t?Array.from(t.values()).map(o=>this.getComponents(o)).map(o=>o.get(e)):[]}removeSystem(t){this.systems.delete(t)}update(t){this.systems.entries().forEach(([e,o])=>{e.update(o,t)}),this.entitiesToDelete.forEach(e=>{this.deleteEntity(e)}),this.entitiesToDelete=[]}draw(t){this.systems.entries().forEach(([e,o])=>{e.draw?.(o,t)})}deleteEntity(t){this.entities.delete(t),this.systems.values().forEach(e=>{e.delete(t)})}checkEntitySystemMemberships(t){for(let e of this.systems.keys())this.checkEntitySystemMembership(t,e)}checkEntitySystemMembership(t,e){let o=this.entities.get(t),i=this.systems.get(e);!o||!i||(Array.from(e.componentSet).every(r=>o.has(r))?i.add(t):i.delete(t))}};var _=class{color;rect;opacity;constructor(t,e){this.color=e,this.rect=t,this.opacity=1}},rt=class{componentSet=new Set([_]);ecs;color;constructor(t){this.color=t}update(){}draw(t,e){t.values().map(i=>this.ecs.getComponents(i)).filter(F).map(i=>i.get(_)).forEach(({rect:i,color:r,opacity:n})=>{n<=0||(n<1&&(e.filter=`opacity(${Math.round(100*n)}%)`),r?e.fillStyle=r:e.fillStyle=this.color,e.fillRect(i.x,i.y,i.width,i.height),e.filter="none")})}};var C=class{velocity;constructor(t){this.velocity=t}},Y=class{componentSet=new Set([c]);ecs;state="pre-lock";update(t){switch(this.state){case"pre-lock":let e=this.ecs.resolveEntities(this.ecs.querySystem(P),f),o=this.ecs.resolveEntities(t,c).filter(i=>i.blocker);if(o.some(i=>e.some(r=>u(i,r))))return;o.forEach(i=>{i.isCollidable=!0}),this.state="locked";return;case"locked":return;case"cleared":return}}},G=class{componentSet=new Set([f]);ecs;update(t,{frameDuration:e}){let o=Array.from(t).map(r=>this.ecs.getComponents(r)),i=this.ecs.resolveEntities(this.ecs.querySystem(Y),c);o.forEach(r=>{let n=r.get(f),h=n.isNonPhysical?[]:i;if(r.has(C)){let a=r.get(C).velocity;n.moveX(a.x*e,()=>{},h),n.moveY(a.y*e,()=>{a.y=0},h)}n.isGrounded(i)})}};var q=class{lifespan;age;constructor(t){this.lifespan=t,this.age=0}},nt=class{componentSet=new Set([_,q,C]);ecs;update(t,{frameDuration:e}){t.values().forEach(o=>{let i=this.ecs.getComponents(o),r=i.get(q),n=i.get(_),{velocity:h}=i.get(C);r.age+=e,r.age>=r.lifespan?this.ecs.removeEntity(o):(n.rect.x+=h.x*e,n.rect.y+=h.y*e,n.opacity=1-et(r.age/r.lifespan))})}};function kt(s,t,e,o,i,r){let n=s.addEntity();return s.addComponent(n,new _({x:t.x-e,y:t.y-e,width:e*2,height:e*2},i)),s.addComponent(n,new C(o)),s.addComponent(n,new q(r)),n}var ce="a",le="s",me="d";var vt=28,Kt=36,pe=56,de=72,ue=450/1e3,fe=2.5/1e3,ye=1,ge=v("./img/sword_man.png"),xe=(s,t,e)=>{let o=0,i=0;return t==="right"&&(o+=vt),s&&(i+=Kt),e&&(o+=vt*2),{x:o,y:i}},H=class{facing;jumpController;constructor(){this.facing="left",this.jumpController=new it}},P=class{componentSet=new Set([H,f,C]);ecs;update(t,{frameDuration:e,keyboardState:o}){t.values().map(i=>this.ecs.getComponents(i)).filter(F).forEach(i=>{let r=i.get(f),n=i.get(C).velocity,h=i.get(H),a=(o[me]?1:0)-(o[ce]?1:0);n.x=w(a*ue,n.x,fe*e);let{yAcceleration:m,isJumping:y}=h.jumpController.update(o,e,n.y);if(n.y+=m*e,y){let D={x:r.x+r.width/2,y:r.y+r.height},O=2;for(let E=0;E<10;E++){let l=g(-.3,.3);kt(this.ecs,{x:D.x+l*r.width,y:D.y},O,{x:l*.6,y:g(.05,.11)*(Math.random()<.7?1:-1)},"white",g(140,240))}n.y=-ye}a>0?h.facing="right":a<0&&(h.facing="left"),r.setDropping(o[le]),h.jumpController.groundedCheck(r.grounded,y)})}draw(t,e){t.values().map(o=>this.ecs.getComponents(o)).filter(F).forEach(o=>{let i=o.get(f),r=o.get(H),n=!1,{x:h,y:a}=xe(n,r.facing,!0);e.drawImage(ge,h,a,vt,Kt,i.x,i.y,i.width,i.height)})}},Gt=(s,t,e)=>{let o=s.addEntity();return s.addComponent(o,new H),s.addComponent(o,new f(t,e,pe,de)),s.addComponent(o,new C({x:0,y:0})),o};var ht=300/1e3,Wt=1/1e3,be=2/1e3,we=v("./img/ghosty.png"),Ut=24,Se=32,Re=48,Ce=64,W=class{hp;facing;isNonPhysical;hurtViz;constructor(){this.hp=3,this.facing="left",this.isNonPhysical=!0,this.hurtViz=I(1,250)}},at=class{componentSet=new Set([W,f,C]);ecs;update(t,{frameDuration:e}){let o=this.ecs.resolveEntities(this.ecs.querySystem(P),f).map(r=>L(r));Array.from(t.values().map(r=>this.ecs.getComponents(r))).forEach(r=>{let n=r.get(W),h=L(r.get(f)),a=r.get(C).velocity,[m]=o.reduce(([y,D],O)=>{let E=z(h,O);return E<D?[O,E]:[y,D]},[void 0,1/0]);m&&(m.x<h.x?(a.x=w(-ht,a.x,Wt*e),n.facing="left"):(a.x=w(ht,a.x,Wt*e),n.facing="right"),a.y=w(m.y<h.y?-ht:ht,a.y,be*e))})}draw(t,e){t.values().forEach(o=>{let i=this.ecs.getComponents(o),r=i.get(W),n=i.get(f);e.drawImage(we,r.facing==="left"?0:Ut,0,Ut,Se,n.x,n.y,n.width,n.height)})}},Xt=(s,t,e)=>{let o=s.addEntity();s.addComponent(o,new W);let i=new f(t,e,Re,Ce);return i.isNonPhysical=!0,s.addComponent(o,i),s.addComponent(o,new C({x:0,y:0})),o};var U=class{loopDuration;start;midpoint;loopState;constructor(t,e,o){this.loopDuration=t,this.start=e,this.midpoint=o,this.loopState=0}},ct=class{componentSet=new Set([c,U]);ecs;update(t,{frameDuration:e}){let o=this.ecs.resolveEntities(this.ecs.querySystem(G),f).filter(r=>!r.isNonPhysical),i=this.ecs.resolveEntities(this.ecs.querySystem(Y),c);t.values().forEach(r=>{let n=this.ecs.getComponents(r),h=n.get(U),a=n.get(c);h.loopState+=e,h.loopState%=h.loopDuration;let m=h.loopState<h.loopDuration/2?h.loopState/h.loopDuration*2:2-h.loopState/h.loopDuration*2,y={x:Et(h.start.x,h.midpoint.x,m),y:Et(h.start.y,h.midpoint.y,m)};a.move(y.x-(a.x+a.xRemainder),y.y-(a.y+a.yRemainder),o,i)})}};var T=(s,t)=>{let e=s.x??s.left,o=s.y??s.top,i=s.width??s.right-e,r=s.height??s.bottom-o;if(isNaN(e)||isNaN(o)||isNaN(i)||isNaN(r))throw new Error("Invalid parameters to create solid!");return new c(e,o,i,r,t)},M=(s={})=>{let t=Object.keys(s).filter(e=>s[e]);return t.sort((e,o)=>S[e][0]-S[o][0]),t};var V=s=>{let t=[],e=[],o=p/2-N/2,i=o+N,r=[0].concat(M(s.top).map(l=>S[l][1])),n=M(s.top).map(l=>S[l][0]).concat(p);t.push(...r.map((l,b)=>T({left:l,right:n[b],y:0,height:x}))),e.push(...M(s.top).map(l=>S[l]).map(([l,b])=>T({left:l,right:b,y:0,height:x})));let h=[0].concat(M(s.bottom).map(l=>S[l][1])),a=M(s.bottom).map(l=>S[l][0]).concat(p);t.push(...h.map((l,b)=>T({left:l,right:a[b],y:d-x,height:x}))),t.push(...M(s.bottom).map(l=>T({left:S[l][0],right:S[l][1],top:d-x,height:x/4},{isDroppable:!0}))),e.push(...M(s.bottom).map(l=>S[l]).map(([l,b])=>T({left:l,right:b,y:d-x,height:x})));let m=[0].concat(M(s.left).map(l=>S[l][1])),y=M(s.left).map(l=>S[l][0]).concat(d);t.push(...m.map((l,b)=>T({top:l,bottom:y[b],left:0,width:x}))),e.push(...M(s.left).map(l=>S[l]).map(([l,b])=>T({top:l,bottom:b,x:0,width:x})));let D=[0].concat(M(s.right).map(l=>S[l][1])),O=M(s.right).map(l=>S[l][0]).concat(d);t.push(...D.map((l,b)=>T({top:l,bottom:O[b],left:p-x,width:x}))),e.push(...M(s.right).map(l=>S[l]).map(([l,b])=>T({top:l,bottom:b,x:p-x,width:x})));let E=[];return E.push(T({left:o-N,width:N,top:420,height:x/4},{isDroppable:!0})),E.push(T({left:o-N,width:N,top:570,height:x/4},{isDroppable:!0})),E.push(T({left:o,right:i,top:140,height:x/4},{isDroppable:!0})),{blockers:e.map(l=>(l.blocker=!0,l.color="brown",l.isCollidable=!1,l)),solids:t,ladders:E}};var x=40,p=1280,d=720,N=x*6,S={high:[120,240],medium:[d/2-40,d/2+80],low:[d-160,d-40],left:[80,280],center:[p/2-100,p/2+100],right:[p-280,p-80]},Jt=["left","center","right"],zt=["high","medium","low"],R=class{getDoorwayChance(){return .5}static getDoorArrangement(){return{top:{},bottom:{},left:{},right:{}}}static isValidAt(t,e){return!0}static areDoorsOk(t){let e=this.getDoorArrangement();return zt.every(o=>(e.left[o]===void 0||t.left[o]===void 0||e.left[o]===t.left[o])&&(e.right[o]===void 0||t.right[o]===void 0||e.right[o]===t.right[o]))&&Jt.every(o=>(e.top[o]===void 0||t.top[o]===void 0||e.top[o]===t.top[o])&&(e.bottom[o]===void 0||t.bottom[o]===void 0||e.bottom[o]===t.bottom[o]))}x;y;width;height;color;blockersLocked;allEnemiesCleared;doors;ecs;constructor(t,e,o,i,r="blue",n={}){this.x=t,this.y=e,this.width=o,this.height=i,this.ecs=new st,this.ecs.addSystem(new G),this.ecs.addSystem(new Y),this.ecs.addSystem(new rt(r)),this.ecs.addSystem(new P),this.ecs.addSystem(new ct),this.ecs.addSystem(new at),this.ecs.addSystem(new nt),this.color=r,this.blockersLocked=!1,this.allEnemiesCleared=!1,this.doors={left:n.left??{},right:n.right??{},top:n.top??{},bottom:n.bottom??{}},this.globalDoorwayRectification(),this.configureAllDoors(),this.configureRoomContent(),Gt(this.ecs,.5*p,.08*d)}globalDoorwayRectification(){this.x===0&&this.y===0?this.doors={bottom:{center:!0,left:!1,right:!1},top:{center:!1,left:!1,right:!1},left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1}}:this.x===0&&this.y===1?this.doors.top={center:!0,left:!1,right:!1}:this.y===1&&(this.doors.top={center:!1,left:!1,right:!1})}configureAllDoors(){let t=this.constructor.getDoorArrangement(),e=this.getDoorwayChance();zt.forEach(o=>{this.doors.left[o]===void 0&&(this.doors.left[o]=t.left[o]??Math.random()<e),this.doors.right[o]===void 0&&(this.doors.right[o]=t.right[o]??Math.random()<e)}),Jt.forEach(o=>{this.doors.top[o]===void 0&&(this.doors.top[o]=t.top[o]??Math.random()<e),this.doors.bottom[o]===void 0&&(this.doors.bottom[o]=t.bottom[o]??Math.random()<e)})}configureRoomContent(){let{solids:t,blockers:e,ladders:o}=V(this.doors);t.concat(e).concat(o).forEach(n=>{let h=this.ecs.addEntity();this.ecs.addComponent(h,n),this.ecs.addComponent(h,new _(n,n.color))});let i=this.ecs.addEntity(),r=new c(300,280,200,40);this.ecs.addComponent(i,r),this.ecs.addComponent(i,new _(r,this.color)),this.ecs.addComponent(i,new U(7e3,{x:300,y:280},{x:600,y:280})),Xt(this.ecs,p,d)}draw(t,e,o,i){t.fillStyle="black",t.fillRect(0,0,e.width,e.height),this.ecs.draw(t)}update(t,e,o,i){this.ecs.update({mousePosition:t,keyboardState:e,frameDuration:o})}validateLeavingRoom(t){}onAllEnemiesCleared(){}setExternalMatchingDoorways(t){let e={};for(let o in t){let i=o;for(let r in t[i]){let n=r;if(i==="left"||i==="right"){let h=r;t[i][h]===!1&&this.doors[i][h]===!0&&(e[i]=e[i]??{},e[i][h]=!0)}else{let h=r;t[i][h]===!1&&this.doors[i][h]===!0&&(e[i]=e[i]??{},e[i][h]=!0)}}}}drawForMap(t){t.fillStyle=this.color}addParticle(t){}};var X=class{x;y;width;height;color;xVelocity;yVelocity;lifeLeft;lifespan;alive;affectedByGravity;constructor(t,e,o,i,r,n,h,a,m=!1){this.x=t,this.y=e,this.width=o,this.height=i,this.color=r,this.xVelocity=n,this.yVelocity=h,this.lifeLeft=a,this.lifespan=a,this.alive=!0,this.affectedByGravity=m}draw(t){t.filter=`opacity(${Math.round(100*this.lifeLeft/this.lifespan)}%)`,t.fillStyle=this.color,t.fillRect(Math.round(this.x),Math.round(this.y),this.width,this.height),t.filter="none"}update(t){this.affectedByGravity&&(this.yVelocity+=t*.0025),this.x+=t*this.xVelocity,this.y+=t*this.yVelocity,this.lifeLeft=Math.max(0,this.lifeLeft-t),this.lifeLeft<=0&&(this.alive=!1)}};var Ee=200,B=120,qt=500/1e3,Tt=v("./img/theghost.png"),De={x:100,y:100,width:p-200,height:d-200},jt={x:-100,y:-100,width:p+200,height:d+200},lt=class{hp;alive;isNonPhysical;facing;x;y;xVelocity=0;yVelocity=0;collider;hurtVisualiser;particleCooldown;strategy;isStrategyComplete;distFromStart;distFromTarget;constructor(t,e){this.hp=20,this.alive=!0,this.isNonPhysical=!1,this.facing="left",this.x=t,this.y=e,this.collider={x:this.x-B/2,y:this.y-B/2,width:B,height:B},this.hurtVisualiser=I(1,250),this.particleCooldown=I(1,40),this.strategy="initialWait",this.isStrategyComplete=!1,this.distFromStart=()=>0,this.distFromTarget=()=>0}update(t,e,o){switch(this.hurtVisualiser.down(t),this.particleCooldown.down(t),this.strategy){case"initialWait":ot(De,o.x,o.y)&&this.initFlee(o);return;case"flee":let i=.8+Math.min(1.2,this.distFromStart()/600);this.collider.x+=this.xVelocity*t*i,this.collider.y+=this.yVelocity*t*i,u(jt,this.collider)||this.initCharge(o),this.addParticle(e);return;case"charge":let r=.8+Math.min(1.2,this.distFromTarget()/600);this.collider.x+=this.xVelocity*t*r,this.collider.y+=this.yVelocity*t*r,this.distFromTarget()<=10&&this.initFlee(o),this.addParticle(e);return}}addParticle(t){if(this.particleCooldown.check()<=0){let e=Bt(this.collider),o=4;t.addParticle(new X(e.x-o/2,e.y-o/2,4,4,"white",this.xVelocity*.3,this.yVelocity*.3,360,!1)),this.particleCooldown.up(1)}}initFlee(t){this.strategy="flee";let e=L(this.collider),o={x:t.x-e.x,y:t.y-e.y},i=Dt(o,qt);this.xVelocity=i.x,this.yVelocity=i.y,this.distFromStart=()=>z(L(this.collider),e)}initCharge(t){this.strategy="charge";let e=Nt(jt);this.collider.x=e.x-B/2,this.collider.y=e.y-B/2;let o=t.x,i=t.y,r={x:o-e.x,y:i-e.y},n=Dt(r,qt);this.xVelocity=n.x,this.yVelocity=n.y,this.distFromTarget=()=>{let h=L(this.collider);return z(h,{x:o,y:i})}}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(10000%) saturate(0%)");let e=Math.round(this.collider.x),o=Math.round(this.collider.y),i=(Ee-B)/2;t.drawImage(Tt,0,0,Tt.width,Tt.height,e-i,o-i,this.collider.width+2*i,this.collider.height+2*i),t.filter="none",!1}applyDamage(t){this.hp-=1,this.hurtVisualiser.up(1),this.hp<0&&(this.alive=!1)}intersects(t){if(u(t,this.collider))return this.collider}};var mt=class extends R{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!0,medium:!1,low:!1},right:{high:!0,medium:!1,low:!1},bottom:{left:!1,center:!1,right:!1},top:{left:!1,center:!1,right:!1}}}static isValidAt(){return!0}configureRoomContent(){let{solids:t,blockers:e}=V(this.doors);this.solids=t.concat(e).concat(...[240,390,540].map(o=>new c(40,o,p-80,10,{isDroppable:!0}))),this.enemies=[new lt(p/2,d/2)]}};var pt=class extends R{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1},bottom:{left:!0,center:!1,right:!0},top:{left:!0,center:!1,right:!0}}}static isValidAt(t,e){return e>=2}configureRoomContent(){let{blockers:t}=V(this.doors);this.solids=t.concat(new c(0,0,80,d),new c(p-80,0,80,d),new c(280,0,720,260),new c(280,460,720,260),new c(80,d-40,200,10,{isDroppable:!0}),new c(120,570,120,10,{isDroppable:!0}),new c(80,460,200,10,{isDroppable:!0}),new c(80,120,200,10,{isDroppable:!0}),new c(80,250,200,10,{isDroppable:!0}),new c(80,355,100,10,{isDroppable:!0}),new c(1e3,d-40,200,10,{isDroppable:!0}),new c(1040,570,120,10,{isDroppable:!0}),new c(1e3,460,200,10,{isDroppable:!0}),new c(1e3,120,200,10,{isDroppable:!0}),new c(1e3,250,200,10,{isDroppable:!0}),new c(1100,355,100,10,{isDroppable:!0}))}};var dt=class extends R{getDoorwayChance(){return .1}static getDoorArrangement(){return{left:{},right:{high:!1,medium:!1,low:!0},bottom:{},top:{left:!0,center:!1,right:!1}}}static isValidAt(t,e){return e>=2}configureRoomContent(){let{solids:t,blockers:e}=V(this.doors);this.solids=t.concat(e).concat(new c(380,0,p-380,450),new c(120,140,120,10,{isDroppable:!0}),new c(40,240,340,10,{isDroppable:!0}),new c(this.doors?.left?.center?160:40,340,this.doors.left.center?220:340,10,{isDroppable:!0}),new c(40,440,340,10,{isDroppable:!0}),new c(40,this.doors.left.low?550:540,240,10,{isDroppable:!0}))}};var $t=340,Vt=76,Zt=60,Qt=80,ut=2.5/1e3,At=v("./img/spitboss-head.png"),It=v("./img/spitboss-base.png"),_t=v("./img/spitboss-spit.png"),ft=class{hp;alive;isNonPhysical;x;y;baseBox;headBox;hurtVisualiser;fireCooldown;constructor(t,e){this.hp=50,this.alive=!0,this.isNonPhysical=!1,this.x=t,this.y=e,this.baseBox={x:this.x-$t/2,y:this.y-Vt,width:$t,height:Vt},this.headBox={x:this.x-Zt/2,y:Math.round(this.y-Qt-.75*Vt),width:Zt,height:Qt},this.hurtVisualiser=I(1,250),this.fireCooldown=I(1,1200)}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(1000%) saturate(0%)");let e=8,o=8;t.drawImage(It,0,0,It.width,It.height,this.baseBox.x-e,this.baseBox.y-o,this.baseBox.width+2*e,this.baseBox.height+o);let i=4;t.drawImage(At,0,0,At.width,At.height,this.headBox.x-i,this.headBox.y-i,this.headBox.width+2*i,this.headBox.height+2*i),t.filter="none",!1}update(t,e,o){if(this.hurtVisualiser.down(t),this.fireCooldown.down(t),this.fireCooldown.check()===0){let i=this.createProjectile(e,o);i&&i.length>0&&(this.fireCooldown.up(1),e.enemies.push(...i))}}createProjectile(t,e){let o={x:this.x-5,width:10,y:0,height:this.y},r=t.solids.filter(l=>l.isCollidable&&!l.isDroppable&&u(l,o)).reduce((l,b)=>Math.max(l,b.y+b.height),0),n=this.y-100,h=n-r-$,a=-Math.sqrt(2*ut*h);if(e.y<=h)return;let m=g(.8,1)*a,y=m*m-2*ut*(n-e.y);if(y<=0)return;let D=(-m+Math.sqrt(y))/ut,O=(e.x-this.x)/D,E=K(1,4);return new Array(E).fill(0).map(()=>new Pt(this.x,n,O+g(-.1,.1),m+g(-.01,.1),this))}applyDamage(t){t===this.headBox?(this.hp-=3,this.hurtVisualiser.up(1)):t===this.baseBox&&(this.hp-=.2,this.hurtVisualiser.up(.2)),this.hp<0&&(this.alive=!1)}intersects(t){if(u(t,this.headBox))return this.headBox;if(u(t,this.baseBox))return this.baseBox}},$=14,Pt=class{actor;xVelocity;yVelocity;parent;alive;struck;hitVisualiser;constructor(t,e,o,i,r){this.actor=new f(t-$,e-$,$*2,$*2),this.xVelocity=o,this.yVelocity=i,this.parent=r,this.alive=!0,this.struck=!1,this.hitVisualiser=I(1,150)}draw(t){t.drawImage(_t,0,0,_t.width,_t.height,this.actor.x-2,this.actor.y-2,this.actor.width+4,this.actor.height+4)}addParticle(t,e,o){t.addParticle(new X(e.x-3,e.y-3,6,6,Math.random()>.5?"#674cd3":"#9e5eff",o.x,o.y,g(120,200),!0))}update(t,e,o){this.hitVisualiser.down(t);let i=r=>n=>{this.alive=!1;let h=r==="x"?{x:this.xVelocity>0?n.x:n.x+n.width,y:this.actor.y+this.actor.height/2}:{x:this.actor.x+this.actor.width/2,y:this.yVelocity>0?n.y:n.y+n.height};for(let a=0;a<12;a++){let m=r==="x"?{x:-this.xVelocity*g(.4,.6),y:g(-.2,.2)}:{x:g(-.2,.2),y:-this.yVelocity*g(.2,.3)};this.addParticle(e,h,m)}};if(this.yVelocity+=ut*t,this.actor.moveX(this.xVelocity*t,i("x"),e.solids),this.actor.moveY(this.yVelocity*t,i("y"),e.solids),this.struck&&this.parent.alive){let r=this.parent.intersects(this.actor);if(r){this.parent.applyDamage(r);let n=Ft(L(this.actor),Yt(r,16));for(let h=0;h<12;h++){let a={x:-this.xVelocity*g(.4,.6)+g(-.2,.2),y:-this.yVelocity*g(.2,.3)+g(-.2,.2)};this.addParticle(e,n,a)}this.alive=!1}}}applyDamage(t,e){this.hitVisualiser.up(1),this.xVelocity=e?.x??0,this.yVelocity=e?.y??0,this.struck=!0}intersects(t){if(u(t,this.actor))return this.actor}};var yt=class extends R{getDoorwayChance(){return .1}static getDoorArrangement(){return{left:{high:!1,medium:!1,low:!1},right:{high:!1,medium:!1,low:!1},bottom:{left:!1,center:!1,right:!1},top:{left:!1,center:!0,right:!1}}}static isValidAt(t,e){return!0}configureRoomContent(){let{solids:t,blockers:e}=V(this.doors);this.solids=t.concat(e).concat(new c(320,160,920,40),new c(840,0,440,200),new c(0,0,80,d),new c(p-80,0,80,d),new c(0,d-80,p,80),new c(80,160,240,10,{isDroppable:!0})),this.enemies=[new ft(780,d-80)]}onAllEnemiesCleared(){super.onAllEnemiesCleared(),this.solids=this.solids.concat(...[320,480].map(t=>new c(80,t,240,10,{isDroppable:!0})))}};var gt=300/1e3,te=1/1e3,ee=2/1e3,Me=v("./img/ghosty.png"),Ot=24,oe=32,ie=2,xt=class{xVelocity;yVelocity;actor;hp;alive;facing;isNonPhysical;hurtVisualiser;constructor(t,e){this.xVelocity=0,this.yVelocity=0,this.actor=new f(t,e,Ot*ie,oe*ie),this.hp=3,this.alive=!0,this.facing="left",this.isNonPhysical=!0,this.hurtVisualiser=I(1,250)}draw(t){this.hurtVisualiser.check()>0&&(t.filter="brightness(1000%) saturate(0%)"),t.drawImage(Me,this.facing==="left"?0:Ot,0,Ot,oe,this.actor.x,this.actor.y,this.actor.width,this.actor.height),t.filter="none",!1}update(t,e,o){this.updateVelocities(t,e,o),this.isNonPhysical?(this.actor.moveX(this.xVelocity*t,()=>{},[]),this.actor.moveY(this.yVelocity*t,()=>{},[])):(this.actor.moveX(this.xVelocity*t,()=>{this.xVelocity=0},e.solids),this.actor.moveY(this.yVelocity*t,()=>{this.yVelocity=0},e.solids)),this.hurtVisualiser.down(t)}updateVelocities(t,e,o){let i=this.actor.getMidpoint();o?(o.x<i.x?(this.xVelocity=w(-gt,this.xVelocity,te*t),this.facing="left"):(this.xVelocity=w(gt,this.xVelocity,te*t),this.facing="right"),o.y<i.y?this.yVelocity=w(-gt,this.yVelocity,ee*t):this.yVelocity=w(gt,this.yVelocity,ee*t)):this.facing=this.xVelocity<0?"left":"right"}applyDamage(t,e){this.hp-=1,this.xVelocity+=e?.x??0,this.yVelocity+=e?.y??0,this.hp<=0&&(this.alive=!1),this.hurtVisualiser.up()}intersects(t){if(u(t,this.actor))return this.actor}};var se=180/1e3,Z=2/1e3,ve=2.5/1e3,Q=class extends xt{constructor(t,e){super(t,e),this.hp=5,this.isNonPhysical=!1,this.facing="left"}updateVelocities(t,e,o){this.yVelocity+=ve*t;let i={x:this.actor.x,y:this.actor.y+this.actor.height,width:this.actor.width,height:1};e.solids.some(r=>r.isCollidable&&u(r,i))||(this.xVelocity=w(0,this.xVelocity,Z/2)),this.facing==="left"?this.canMoveLeft(e)?this.xVelocity=w(-se,this.xVelocity,Z):this.canMoveRight(e)&&(this.facing="right",this.xVelocity=w(0,this.xVelocity,Z)):this.canMoveRight(e)?this.xVelocity=w(se,this.xVelocity,Z):this.canMoveLeft(e)&&(this.facing="left",this.xVelocity=w(0,this.xVelocity,Z))}canMoveLeft(t){let e={x:this.actor.x-this.actor.width/2,y:this.actor.y+this.actor.height,width:this.actor.width/4,height:1},o={x:this.actor.x-this.actor.width,y:this.actor.y,height:this.actor.height,width:this.actor.width};return t.solids.some(i=>i.isCollidable&&!i.isDroppable&&u(i,e))&&t.solids.every(i=>!i.isCollidable||!u(i,o))}canMoveRight(t){let e={x:this.actor.x+this.actor.width/4*5,y:this.actor.y+this.actor.height,width:this.actor.width/4,height:1},o={x:this.actor.x+this.actor.width,y:this.actor.y,height:this.actor.height,width:this.actor.width};return t.solids.some(i=>i.isCollidable&&!i.isDroppable&&u(i,e))&&t.solids.every(i=>!i.isCollidable||i.isDroppable||!u(i,o))}applyDamage(t,e){super.applyDamage(t,e),this.yVelocity-=.3}};var bt=class extends R{getDoorwayChance(){return 0}static getDoorArrangement(){return{left:{high:!0,medium:!1,low:!1},right:{high:!0,medium:!1,low:!1},bottom:{left:!1,center:!0,right:!1},top:{}}}configureRoomContent(){let{solids:t,blockers:e}=V(this.doors);this.solids=t.concat(e).concat(new c(0,240,440,d-240),new c(840,240,p-840,d-240),new c(440,240,400,10,{isDroppable:!0}),new c(440,380,400,10,{isDroppable:!0}),new c(440,520,400,10,{isDroppable:!0})).concat(...[this.doors.top.left?new c(120,120,120,10,{isDroppable:!0}):void 0,this.doors.top.center?new c(580,120,120,10,{isDroppable:!0}):void 0,this.doors.top.right?new c(1040,120,120,10,{isDroppable:!0}):void 0].filter(F)),this.enemies=[new Q(p/4,176),new Q(p*3/4,176)]}};var k=128,J=72,re=9,ne=6,he=1/10,tt=2,ae=4,wt=class{lastRoomIndex;map;x;y;currentIndex;minX;minY;canvas;ctx;constructor(){this.lastRoomIndex={x:0,y:0},this.map={},this.x=0,this.y=0,this.currentIndex=this.index(0,0),this.minX=0,this.minY=0;let t=new R(0,0,1,1);this.map[this.index(0,0)]=t;let e=Math.max(re),o=Math.max(ne);this.canvas=new OffscreenCanvas(e*k,o*J);let i=this.canvas.getContext("2d");if(!i)throw Error("Could not construct canvas");this.ctx=i,this.redrawWorldMap()}createNewCanvas(t,e,o,i){let r=Math.max(re,e-t+1+ae),n=Math.max(ne,i-o+1+ae);this.canvas=new OffscreenCanvas(r*k,n*J);let h=this.canvas.getContext("2d");if(!h)throw Error("Could not construct canvas");this.ctx=h}getNeighboringDoors(t,e){return{right:{...this.map[this.index(t+1,e)]?.doors?.left},left:{...this.map[this.index(t-1,e)]?.doors?.right},top:{...this.map[this.index(t,e-1)]?.doors?.bottom},bottom:{...this.map[this.index(t,e+1)]?.doors?.top}}}generateRoomChoices(t,e,o={}){let i=()=>`hsl(${K(0,360)}, 60%, 60%)`,r=()=>({left:{...o.left??{}},right:{...o.right??{}},top:{...o.top??{}},bottom:{...o.bottom??{}}}),n=[mt,pt,dt,bt,yt],h=r(),a=n.filter(y=>y.isValidAt(t,e)&&y.areDoorsOk(h));a.push(R,R,R);let m=[];for(let y=0;y<3;y++){let D=a.shift();if(!D)throw new Error("Could not find enough rooms");m.push(new D(t,e,1,1,i(),r()))}return m}redrawWorldMap(){let t=0,e=0;for(let o of Object.values(this.map))this.minX=Math.min(this.minX,o.x),t=Math.max(t,o.x),this.minY=Math.min(this.minY,o.y),e=Math.max(e,o.y);(t-this.minX+1>this.canvas.width/k||e-this.minY+1>this.canvas.height/J)&&this.createNewCanvas(this.minX,t,this.minY,e),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let o of Object.values(this.map))this.ctx.save(),this.ctx.translate((o.x-this.minX)*k,(o.y-this.minY)*J),this.ctx.scale(he,he),o.drawForMap(this.ctx),this.ctx.restore()}drawMapToScreen(t,e,o,i,r){let n=Math.min(i,this.canvas.width),h=Math.min(r,this.canvas.height),a=(-this.minX+this.x+1/2)*k-i/2;t.drawImage(this.canvas,a,0,n,h,e,o,n,h),t.strokeStyle="white",t.lineWidth=tt,t.strokeRect(-a+(this.x-this.minX+1/2)*k-tt,o+this.y*J-tt,k+tt*2,J+tt*2)}index(t,e){return`${t},${e}`}getCurrentRoom(){return this.map[this.currentIndex]}getPreviousRoom(){return this.map[this.index(this.lastRoomIndex.x,this.lastRoomIndex.y)]}hasRoom(t,e){return this.index(t,e)in this.map}enterRoom(t,e){this.lastRoomIndex={x:this.x,y:this.y},this.x=t,this.y=e,this.currentIndex=this.index(t,e),this.redrawWorldMap()}addRoom(t){if(this.map[this.currentIndex])throw new Error("Adding room where we already have one!");this.map[this.currentIndex]=t,this.map[this.index(this.x-1,this.y)]?.setExternalMatchingDoorways?.({right:t.doors.left}),this.map[this.index(this.x+1,this.y)]?.setExternalMatchingDoorways?.({left:t.doors.right}),this.map[this.index(this.x,this.y-1)]?.setExternalMatchingDoorways?.({bottom:t.doors.top}),this.map[this.index(this.x,this.y+1)]?.setExternalMatchingDoorways?.({top:t.doors.bottom}),t.setExternalMatchingDoorways({left:this.map[this.index(this.x-1,this.y)]?.doors?.right,right:this.map[this.index(this.x+1,this.y)]?.doors?.left,top:this.map[this.index(this.x,this.y-1)]?.doors?.bottom,bottom:this.map[this.index(this.x,this.y+1)]?.doors?.top}),this.redrawWorldMap()}};var St=10,Te="Tab",A=64,Rt=4,Ct=class{worldMap;lastFrameTime;unprocessedTime;pausedFor;choosing;choices;tabLatch;mouseOverChoiceIndex;firstTickInNewRoom;constructor(){this.worldMap=new wt,this.lastFrameTime=performance.now(),this.unprocessedTime=0,this.pausedFor=void 0,this.choosing=!0,this.choices=[],this.tabLatch=Lt(!1),this.mouseOverChoiceIndex=-1,this.firstTickInNewRoom=!1}update(t,e,o,i){if(this.tabLatch(!!i[Te],{onLock:()=>{this.pausedFor==="Tab"?(this.lastFrameTime=performance.now(),this.pausedFor=void 0):this.pausedFor||(this.pausedFor="Tab")}}),this.pausedFor==="choices"){this.choices.length===0&&(this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y)),this.draw(t,e,o,0),this.drawMap(t,e),this.drawOptions(t,e,o);return}else if(this.pausedFor==="Tab"){this.draw(t,e,o,0),this.drawMap(t,e);return}let r=performance.now(),n=this.firstTickInNewRoom?0:Math.min(r-this.lastFrameTime,250);for(this.lastFrameTime=r,this.firstTickInNewRoom=!1,this.unprocessedTime+=n;this.unprocessedTime>=St&&!this.pausedFor;)this.simulateFrame(o,i),this.unprocessedTime-=St;this.pausedFor&&(this.unprocessedTime=0);let h=this.unprocessedTime/St;this.draw(t,e,o,h)}drawMap(t,e){t.fillStyle="#00000099",t.fillRect(0,0,e.width,e.height),t.fillStyle="white",t.fillRect(A-Rt,A-Rt,e.height-(A-Rt)*2,e.height-(A-Rt)*2),t.fillStyle="black",t.fillRect(A,A,e.height-A*2,e.height-A*2),this.worldMap.drawMapToScreen(t,A,A,e.height-A*2,e.height-A*2)}click(t,e){let o=this.pausedFor==="choices"&&this.choices.length>0,i=this.mouseOverChoiceIndex>=0&&this.mouseOverChoiceIndex<this.choices.length;if(o&&i){let r=this.choices[this.mouseOverChoiceIndex];this.worldMap.addRoom(r);let n=this.worldMap.getPreviousRoom();this.transferPlayerPosition(n,r),this.unprocessedTime=0,this.firstTickInNewRoom=!0,this.pausedFor=void 0,this.choices=[]}}transferPlayerPosition(t,e){let o=t.ecs.querySystem(P),i=e.ecs.querySystem(P);if(o?.size!==1||i?.size!==1)return;let r=t.ecs.getComponents(Array.from(o.values())[0]),n=e.ecs.getComponents(Array.from(i.values())[0]);if(!r||!n)return;let h=r.get(H),a=n.get(H)}simulateFrame(t,e){this.worldMap.getCurrentRoom().update(t,e,St,this.onRoomChange.bind(this))}onRoomChange(t,e,o){this.worldMap.hasRoom(t,e)?(this.worldMap.enterRoom(t,e),this.transferPlayerPosition(this.worldMap.getPreviousRoom(),this.worldMap.getCurrentRoom())):(this.pausedFor="choices",this.worldMap.enterRoom(t,e),this.choices=this.worldMap.generateRoomChoices(this.worldMap.x,this.worldMap.y,o))}draw(t,e,o,i){let r=this.worldMap.getCurrentRoom();r&&r.draw(t,e,o,i)}drawOptions(t,e,o){this.mouseOverChoiceIndex=-1;for(let i=0;i<this.choices.length;i++){let r=this.choices[i],n=e.height,h=e.width,a=(n+h)/2,m=e.height/this.choices.length,y=m*i,D=y+m;t.save(),t.translate(a,(y+D)/2);let O=o&&ot({x:n,y,width:h-n,height:m},o.x,o.y),E=(h-n)/p*.5;t.scale(E,E),O&&(this.mouseOverChoiceIndex=i,t.scale(1.1,1.1)),t.translate(-p/2,-d/2),r.drawForMap(t),t.restore()}}};function Ve(){let s=document.getElementById("canvas");if(!s){console.error("Could not find canvas");return}let t=s.getContext("2d");if(!t)throw Error("Could not set up canvas rendering context");t.imageSmoothingEnabled=!1;let e=new Ct,o;s.addEventListener("mousemove",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,m=n.clientY-h.top;o={x:a,y:m}}),s.addEventListener("mouseleave",()=>{o=void 0}),s.addEventListener("click",n=>{let h=s.getBoundingClientRect(),a=n.clientX-h.left,m=n.clientY-h.top;o={x:a,y:m},e.click(s,o)});let i={};window.addEventListener("keydown",n=>{i[n.key]=!0,(n.key==="Tab"||n.key===" ")&&n.preventDefault()}),window.addEventListener("keyup",n=>{delete i[n.key]}),window.addEventListener("blur",()=>{i={}});function r(){e.update(t,s,o,i),requestAnimationFrame(r)}r()}document.addEventListener("DOMContentLoaded",()=>{Ve()});})();
//# sourceMappingURL=index.js.map
